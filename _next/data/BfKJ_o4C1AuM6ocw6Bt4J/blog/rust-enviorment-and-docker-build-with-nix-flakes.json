{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var r=Object.create;var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var i=a=>l(a,\"__esModule\",{value:!0});var m=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=>{i(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},N=(a,s,c)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let e of p(s))!u.call(a,e)&&e!==\"default\"&&l(a,e,{get:()=>s[e],enumerable:!(c=d(s,e))||c.enumerable});return a},g=a=>N(i(l(a!=null?r(h(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=m((v,t)=>{t.exports=_jsx_runtime});var w={};k(w,{default:()=>y,frontmatter:()=>f});var n=g(o()),f={title:\"Rust Environment and Docker Build with Nix Flakes\",date:\"2022-05-17\",tags:[\"rust\",\"nix\",\"docker\"],draft:!0,summary:\"Reproducible dev environments and build with nix\",images:[],layout:\"PostLayout\"};function x(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",ul:\"ul\",li:\"li\",code:\"code\",pre:\"pre\",h3:\"h3\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"why-nix\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#why-nix\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Why Nix\"]}),`\n`,(0,n.jsxs)(e.p,{children:[`Getting a dev environment setup with rust is usually pretty simple, just use rustup then you're good to go.\nUsing a build tool like `,(0,n.jsx)(e.a,{href:\"https://nixos.org/\",children:\"nix\"}),\" can buy you much more for not much extra work. Nix lets you\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Specify non rust project dependencies in code\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"Automatically add all your projects tools/dependencies to your path with \",(0,n.jsx)(e.a,{href:\"https://direnv.net/\",children:\"direnv\"})]}),`\n`,(0,n.jsx)(e.li,{children:\"Easily build slim docker containers\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:`Once you start working in a repo with nix you never want to go back.\nNo more READMEs with a list of Homebrew, apt, pacman, etc. commands you need to run.\nBuilding slim docker containers is a breeze without needing to manually handle multiple layers to copy build artifacts from.`}),`\n`,(0,n.jsxs)(e.h2,{id:\"the-dev-environment\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#the-dev-environment\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Dev environment\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We will use \",(0,n.jsx)(e.a,{href:\"https://nixos.wiki/wiki/Flakes\",children:\"nix flakes\"}),` to set up nix for our project.\nFlakes are nix's newish way to make nix builds more reproducible by adding a lock file concept to the project.\nEach flake can have `,(0,n.jsx)(e.code,{children:\"inputs\"}),\" which are other flakes/nix files and many \",(0,n.jsx)(e.a,{href:\"https://nixos.wiki/wiki/Flakes#Output_schema\",children:\"outputs\"}),`.\nOne thing to note, all files referenced in your flake (including itself) must be added to git.\nIf you run into any file not found errors make sure you `,(0,n.jsx)(e.code,{children:\"git add\"}),\" everything you need.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"To get started in the root of your project run\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-sh code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`nix flake init\n`})})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This will give you a \",(0,n.jsx)(e.code,{children:\"flake.nix\"}),\" file that looks like\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  description \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"A very basic flake\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  outputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nixpkgs \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    packages\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"x86_64\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"linux\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"legacyPackages\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"x86_64\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"linux\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    defaultPackage\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"x86_64\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"linux \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"packages\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"x86_64\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"linux\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This starter flake will build a hello world binary with \",(0,n.jsx)(e.code,{children:\"nix build .#hello\"}),\" which calls the first line or with just \",(0,n.jsx)(e.code,{children:\"nix build\"}),\" to call the \",(0,n.jsx)(e.code,{children:\"defaultPackage\"}),` line.\nThe downside is this only builds the package on x86/64 Linux, let's add some inputs to generalize this to more systems.`]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  inputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"url \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"url \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"github:numtide/flake-utils\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  outputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lib\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"eachDefaultSystem \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"system\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"let\"}),\" pkgs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" nixpkgs \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"inherit\"}),\" system\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        packages\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        defaultPackage \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"hello\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We added two inputs, the first is \",(0,n.jsx)(e.code,{children:\"nixpkgs\"}),` which lets us specify which version of nixpkgs we should use.\nThere are many `,(0,n.jsx)(e.a,{href:\"https://search.nixos.org/packages\",children:\"thousands of packages\"}),` in the nixpkg repository, and they are updated often so here will use the unstable branch.\nWe also added `,(0,n.jsx)(e.a,{href:\"https://github.com/numtide/flake-utils\",children:\"flake-utils\"}),\" which helps us generalize the flake to support multiple systems, not just Linux.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now on Linux and mac the hello package will build. Now run \",(0,n.jsx)(e.code,{children:\"nix build\"}),\", you should see a \",(0,n.jsx)(e.code,{children:\"result\"}),\" folder which contains the \",(0,n.jsx)(e.code,{children:\"hello\"}),` package,\nyou can run it with `,(0,n.jsx)(e.code,{children:\"./result/bin/hello\"}),\".\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"rust-in-nix\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#rust-in-nix\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Rust in nix\"]}),`\n`,(0,n.jsx)(e.p,{children:'To move on from \"hello world\" to rust lets add another input'}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"inputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"url \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"url \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"github:numtide/flake-utils\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"url \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"github:oxalica/rust-overlay\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  outputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lib\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"eachDefaultSystem \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"system\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"let\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        overlays \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        pkgs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" nixpkgs \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"inherit\"}),\" system overlays\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustVersion \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"bin\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"stable\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"latest\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"default\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        devShell \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"mkShell \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          buildInputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"override \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" extensions \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust-src\"'}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now we added \",(0,n.jsx)(e.a,{href:\"https://github.com/oxalica/rust-overlay\",children:\"rust-overlay\"}),` so we can easily specify different rust versions\nwithout relying on `,(0,n.jsx)(e.code,{children:\"nixpkgs\"}),\" to give us what ever rust version in there.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We also switched the \",(0,n.jsx)(e.code,{children:\"outyputs\"}),\" to only have \",(0,n.jsx)(e.code,{children:\"devShell\"}),\". Now when you run \",(0,n.jsx)(e.code,{children:\"nix develop\"}),\" you will get a new sandboxed shell with the stable rust version.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[`If you want to use a specific version/nightly build you can use\n`,(0,n.jsx)(e.code,{children:\"rustVersion = (pkgs.rust-bin.fromRustupToolchainFile ./rust-toolchain.toml);\"}),\" to read a rust toolchain file and use the version specified in there.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"You may also have noticed we added \",(0,n.jsx)(e.code,{children:'.override { extensions = [ \"rust-src\" ]; })'}),\". This is needed for rust analyzer to get rust source code.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"automatically-load-the-nix-environment\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#automatically-load-the-nix-environment\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Automatically load the nix environment\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now that we have the rust version we want let's make the \",(0,n.jsx)(e.code,{children:\"nix develop\"}),\" step automatic.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Install \",(0,n.jsx)(e.a,{href:\"https://direnv.net/\",children:\"direnv\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://github.com/nix-community/nix-direnv\",children:\"nix-direnv\"}),`.\nThe second is optional but helps with caching, so I recommend it.`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Direnv will add hooks to your shell so when you \",(0,n.jsx)(e.code,{children:\"cd\"}),\" into your project it will autoload the nix environment for you without needing to run \",(0,n.jsx)(e.code,{children:\"nix develop\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"In the root of your project run\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"language-sh code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`echo \"use flake\" >> .envrc\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`direnv allow\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.code,{children:\".envrc\"}),\" file will be loaded by direnv, and it will use the flake's \",(0,n.jsx)(e.code,{children:\"devShell\"}),` output to set up your environment.\nOn changes to your flake direnv will reload only what has changed.`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"build-rust-project\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#build-rust-project\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Build rust project\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Now that we have rust in our dev environment we can make a new rust app with\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-sh code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`cargo init\n`})})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Then we can build the project like you normally would with \",(0,n.jsx)(e.code,{children:\"cargo build\"}),`.\nThat works well while developing but let's use nix to build the project, this will help us later on when we make the docker image.`]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's update the outputs too\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"outputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lib\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"eachDefaultSystem \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"system\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"let\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        overlays \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        pkgs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" nixpkgs \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"inherit\"}),\" system overlays\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustVersion \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"bin\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"stable\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"latest\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"default\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustPlatform \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"makeRustPlatform \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          cargo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          rustc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        myRustBuild \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustPlatform\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"buildRustPackage \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          pname \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust_nix_blog\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# make this what ever your cargo.toml package.name is\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"0.1.0\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          src \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./.\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# the folder with the cargo.toml\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          cargoLock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lockFile \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./Cargo.lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        defaultPackage \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" myRustBuild\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        devShell \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"mkShell \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          buildInputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"override \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" extensions \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust-src\"'}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"First we have to make a \",(0,n.jsx)(e.code,{children:\"rustPlatform\"}),` with our rust version.\nThen that will let us build our rust package with `,(0,n.jsx)(e.code,{children:\"rustPlatform.buildRustPackage\"}),\". This is the equivalent of \",(0,n.jsx)(e.code,{children:\"cargo build\"}),`.\nWe need `,(0,n.jsx)(e.code,{children:\"cargoLock.lockFile\"}),\" so nix can cache all of your project's dependencies based on your existing lock file.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now we can run \",(0,n.jsx)(e.code,{children:\"nix build\"}),\", then your project will be in the \",(0,n.jsx)(e.code,{children:\"result\"}),\" folder again. In my case I can run \",(0,n.jsx)(e.code,{children:\"./result/bin/rust_nix_blog\"}),\".\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"make-a-docker-image\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#make-a-docker-image\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Make a docker image\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Now that we have nix building the rust project making the docker container is quite easy.\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"outputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" self\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nixpkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flake\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"utils\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lib\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"eachDefaultSystem \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"system\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"let\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        overlays \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"overlay\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        pkgs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"import\"}),\" nixpkgs \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"inherit\"}),\" system overlays\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustVersion \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"rust\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"bin\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"stable\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"latest\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"default\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustPlatform \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"makeRustPlatform \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          cargo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          rustc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        myRustBuild \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" rustPlatform\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"buildRustPackage \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          pname \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust_nix_blog\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# make this what ever your cargo.toml package.name is\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"0.1.0\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          src \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./.\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# the folder with the cargo.toml\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          cargoLock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lockFile \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./Cargo.lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        dockerImage \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"dockerTools\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"buildImage \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          name \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust-nix-blog\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          config \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" Cmd \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsxs)(e.span,{className:\"token string\",children:['\"',(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token antiquotation important\",children:\"$\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\"myRustBuild\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),'/bin/rust_nix_blog\"']}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        rustPackage \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" myRustBuild\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        docker \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" dockerImage\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`~~~~\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        defaultPackage \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" dockerImage\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        devShell \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" pkgs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"mkShell \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          buildInputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rustVersion\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"override \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" extensions \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust-src\"'}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now \",(0,n.jsx)(e.code,{children:\"nix build\"}),\" or \",(0,n.jsx)(e.code,{children:\"nix build .#docker\"}),\" will build the docker image. After building \",(0,n.jsx)(e.code,{children:\"result\"}),` is just a sym link to the image tar file of a folder like before.\nSince nix is declarative it does not load it directly into docker for you. You can load it with`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-sh code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`docker load < result\n`})})}),`\n`,(0,n.jsxs)(e.p,{children:[\"You should see an output like \",(0,n.jsx)(e.code,{children:\"rust-nix-blog:yyc9gd4nkydrikzpsvlp3gmwnpxhh1ik\"}),\" which is the image and tag loaded in.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Now run the image with\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-sh code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`docker run rust-nix-blog:yyc9gd4nkydrikzpsvlp3gmwnpxhh1ik\n`})})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can automate this a bit with a script like. (Slightly modified example from \",(0,n.jsx)(e.a,{href:\"https://jamey.thesharps.us/2021/02/02/docker-containers-nix/\",children:\"here\"}),\")\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"language-sh code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`#!/usr/bin/env bash\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`set -e; set -o pipefail;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`nix build '.#docker'\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`image=$((docker load < result) | sed -n '$s/^Loaded image: //p')\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`docker image tag \"$image\" rust-nix-blog:latest\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Let's use \",(0,n.jsx)(e.a,{href:\"https://github.com/wagoodman/dive\",children:\"dive\"}),\" to look at the image. You can use it temporarily with \",(0,n.jsx)(e.code,{children:\"nix shell nixpkgs#dive\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Looking at the output you can see it's a single layer image with just they need nix store package to run the binary (in case just libc and the rust code).\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"common-troubleshooting-issues\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#common-troubleshooting-issues\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Common troubleshooting issues\"]}),`\n`,(0,n.jsxs)(e.h3,{id:\"non-rust-build-dependencies\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#non-rust-build-dependencies\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Non rust build dependencies\"]}),`\n`,(0,n.jsxs)(e.p,{children:[`Building with nix is great once its working, it will stay working forever.\nGetting to a working state can be a bit of pain sometimes.\nIf your rust code relies on system packages (like OpenSSL) make sure you include them in `,(0,n.jsx)(e.code,{children:\"buildInputs\"}),\", for example\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-nix\",children:(0,n.jsxs)(e.code,{className:\"language-nix code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rustPlatform\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"buildRustPackage \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  pname \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"rust_nix_blog\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# make this what ever your cargo.toml package.name is\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"0.1.0\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  src \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./.\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# the folder with the cargo.toml\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  nativeBuildInputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"pkg\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\"config \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# just for the host building the package\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  buildInputs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"openssl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# packages needed by the consumer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  cargoLock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"lockFile \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token url\",children:\"./Cargo.lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"For OpenSSL specifically I would recommend using rusttls when possible. It's easier to build and in rust.\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"nix-docs\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#nix-docs\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Nix Docs\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Nix documentation is not the best. While the \",(0,n.jsx)(e.a,{href:\"https://nixos.wiki/wiki/Rust\",children:\"wiki\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://nixos.org/manual/nixpkgs/stable/#preface\",children:\"manual\"}),\" have some info, I've found the best resources have been the many nix bloggers out there. Here are some good references\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://christine.website/blog/nix-flakes-1-2022-02-21\",children:\"Xe\"}),\" most of her blogs relate to nixos, the Linux distro based on nix, but it helps to learn the language and common patterns\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://ianthehenry.com/posts/how-to-learn-nix/\",children:\"Ian Henry's how to learn nix\"}),\" Ian has a blog series of him learning nix. It's not really documentation but more curated notes of his process of using nix.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://www.tweag.io/blog/2020-05-25-flakes/\",children:\"Intro to nix flakes\"}),\" Great 3 part series on what flakes are and how to use them\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://jamey.thesharps.us/2021/02/02/docker-containers-nix/\",children:\"Building docker containers with nix\"}),\" Linked this earlier, but it's a good reference for more options on building containers\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"I also highly recommend on diving headfirst into nix by using Nixos as your Linux distro. It will help make you more comfortable with the language and its great to use once it clicks.\"})]})}}var y=x;return w;})();\n;return Component;","toc":[{"value":"Why Nix","url":"#why-nix","depth":2},{"value":"The Dev environment","url":"#the-dev-environment","depth":2},{"value":"Rust in nix","url":"#rust-in-nix","depth":2},{"value":"Automatically load the nix environment","url":"#automatically-load-the-nix-environment","depth":2},{"value":"Build rust project","url":"#build-rust-project","depth":2},{"value":"Make a docker image","url":"#make-a-docker-image","depth":2},{"value":"Common troubleshooting issues","url":"#common-troubleshooting-issues","depth":2},{"value":"Non rust build dependencies","url":"#non-rust-build-dependencies","depth":3},{"value":"Nix Docs","url":"#nix-docs","depth":3}],"frontMatter":{"readingTime":{"text":"11 min read","minutes":10.63,"time":637800,"words":2126},"slug":"rust-enviorment-and-docker-build-with-nix-flakes","fileName":"rust-enviorment-and-docker-build-with-nix-flakes.md","title":"Rust Environment and Docker Build with Nix Flakes","date":"2022-05-17T00:00:00.000Z","tags":["rust","nix","docker"],"draft":true,"summary":"Reproducible dev environments and build with nix","images":[],"layout":"PostLayout"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.215,"time":12900,"words":43},"slug":["default"],"fileName":"default.md","name":"John Murray","avatar":"/static/images/me.jpg","occupation":"Software Engineer","github":"https://github.com/JRMurr","date":null}],"prev":{"title":"Intermediate Typescript: Generics and Mapped Types","date":"2022-01-31T00:00:00.000Z","tags":["Typescript","code","types","guide"],"draft":false,"summary":"Useful applications of generics and mapped types","images":[],"layout":"PostLayout","slug":"intermediate-typescript-generics-and-mapped-types"},"next":null},"__N_SSG":true}