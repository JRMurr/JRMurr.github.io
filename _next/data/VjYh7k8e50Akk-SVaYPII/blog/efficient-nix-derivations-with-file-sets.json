{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var h=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var F=n=>c(n,\"__esModule\",{value:!0});var u=(n,s)=>()=>(s||n((s={exports:{}}).exports,s),s.exports),f=(n,s)=>{F(n);for(var r in s)c(n,r,{get:s[r],enumerable:!0})},v=(n,s,r)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let e of y(s))!C.call(n,e)&&e!==\"default\"&&c(n,e,{get:()=>s[e],enumerable:!(r=p(s,e))||r.enumerable});return n},N=n=>v(F(c(n!=null?h(m(n)):{},\"default\",n&&n.__esModule&&\"default\"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var d=u((k,a)=>{a.exports=_jsx_runtime});var b={};f(b,{default:()=>A,frontmatter:()=>B});var l=N(d()),B={title:\"Efficient Nix Derivations with File Sets\",date:new Date(1701552164113),tags:[\"nix\",\"nix-pkgs\"],draft:!1,summary:\"Using nix's new file set API to make efficient derivations\",images:[],layout:\"PostLayout\"};function g(n={}){let{wrapper:s}=n.components||{};return s?(0,l.jsx)(s,Object.assign({},n,{children:(0,l.jsx)(r,{})})):r();function r(){let e=Object.assign({p:\"p\",pre:\"pre\",div:\"div\",code:\"code\",span:\"span\",strong:\"strong\",a:\"a\",h2:\"h2\"},n.components),{TOCInline:o,Note:i}=e;return i||t(\"Note\",!0),o||t(\"TOCInline\",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o,{toc:n.toc,asDisclosure:!0}),`\n`,(0,l.jsx)(e.p,{children:\"If you are using Nix to build your own packages you will eventually come across something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"my awesome pkg\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        # I have no idea if this actually works (the gcc call bit)\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        # but the vibe is what I care about\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        gcc main.c -o my_program\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        mkdir -p $out\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        cp my_program $out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The issue with the above is setting \",(0,l.jsx)(e.code,{children:\"src = ./.\"}),\", which makes \",(0,l.jsx)(e.strong,{children:\"ALL\"}),` of the current directory an input to the derivation.\nSo if you have a readme file in this folder, changing that will cause this derivation to rebuild.`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The build only really cares about \",(0,l.jsx)(e.code,{children:\"main.c\"}),\" in this case so what can we do to fix this?\"]}),`\n`,(0,l.jsxs)(e.p,{children:[`Back in the dark dark times of pre-Nixos 23.11, there were ways to do this kind of filtering but IMO they were kinda confusing and\nI never quite got it to work right so I just stuck with `,(0,l.jsx)(e.code,{children:\"src = ./.\"})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Now with 23.11 we have \",(0,l.jsx)(e.a,{href:\"https://www.tweag.io/blog/2023-11-28-file-sets/\",children:\"filesets\"}),\", which makes filtering and adding files much simpler.\"]}),`\n`,(0,l.jsxs)(e.h2,{id:\"what-are-file-sets\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#what-are-file-sets\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"What are file sets\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I would recommend checking out the \",(0,l.jsx)(e.a,{href:\"https://nixos.org/manual/nixpkgs/unstable/#sec-functions-library-fileset\",children:\"docs\"}),\" or \",(0,l.jsx)(e.a,{href:\"https://nix.dev/tutorials/file-sets\",children:\"official tutorial\"}),\", but for a TLDR, you can do the following\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"baseSrc\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"unions\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./Makefile\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"filterMarkdownFiles\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"hasSuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".md\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"removedMarkedDown\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"difference\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseSrc\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"filterMarkdownFiles\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"my awesome pkg\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"removedMarkedDown\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"       # call make or w/e you want\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:['Now with this setup, we have a \"base\" file set of ',(0,l.jsx)(e.code,{children:\"[ ./Makefile ./src ]\"}),\" then with \",(0,l.jsx)(e.code,{children:\"fs.difference\"}),\" we can remove all files that are markdown with the \",(0,l.jsx)(e.code,{children:\"filterMarkdownFiles\"}),\" filter.\"]}),`\n`,(0,l.jsxs)(e.h2,{id:\"a-real-example\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#a-real-example\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"A Real Example\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Recently I started messing around with the language \",(0,l.jsx)(e.a,{href:\"https://www.roc-lang.org/\",children:\"Roc\"}),`. If you haven't heard of it, Roc is a new functional language heavily inspired by Elm.\nIt's fast but also very nice to use (though some rough edges since it's pre-0.1.0).`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"One of its interesting ideas is that Roc needs your app to pick what \",(0,l.jsx)(e.a,{href:\"https://www.roc-lang.org/platforms\",children:\"platform\"}),` to run on.\nA platform would be written in something like rust, zig, c, etc.\nThe platform provides roc APIs for things like managing memory, making network requests, printing to stdout, and other IO-like actions.\nRight now the two most widely used are a `,(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/basic-cli\",children:\"cli platform\"}),\" and \",(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/basic-webserver\",children:\"webserver platform\"})]}),`\n`,(0,l.jsx)(e.p,{children:`This is really neat but brings an issue for developing a platform along with the roc code needed to define the platform API.\nYou need to compile the \"platform code\" (ie rust + some c), do w/e linking is needed for that, then distribute that with the roc source code.\nThe roc cli will do this for you when developing but it doesn't work as nicely tp compile just the platform with nix.`}),`\n`,(0,l.jsxs)(e.p,{children:[\"For example, \",(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/roc/tree/main/examples/platform-switching/rust-platform\",children:\"this\"}),\" is one of the sample platforms\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"shell\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u276F exa --tree --level 2\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\".\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 Cargo.lock\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 Cargo.toml\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 host.c\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 main.roc\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 rust-toolchain.toml\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 src\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u251C\\u2500\\u2500 glue.rs\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u251C\\u2500\\u2500 lib.rs\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u2514\\u2500\\u2500 main.rs\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"To build this platform you need to run a \",(0,l.jsx)(e.code,{children:\"cargo build --lib ...\"}),\" on the rust code, compile the \",(0,l.jsx)(e.code,{children:\"host.c\"}),` file,\nlink those two object files together, and then finally distribute the linked object file with the roc code.`]}),`\n`,(0,l.jsx)(e.p,{children:\"so after all those steps, it should look something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"shell\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u276F exa --tree \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"<\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"compiled folder\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\">\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"<\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"compiled folder\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\">\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 linux-x64.o\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 main.roc\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:\"The naive approach would probably be something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"compiledC\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# compile the c ...\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"};\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustBuiltLib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildRustPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# build the rust\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"};\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"llvmPkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"rec\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pname\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"-\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"srcs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuiltLib\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"compiledC\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# for the roc code\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  ];\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"sourceRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # link the rust and c files\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # copy roc and linked object out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"  ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"while this works, it also sucks. \",(0,l.jsx)(e.strong,{children:\"ANY\"}),\" change to the files will cause all 3 derivations to be rebuilt.\"]}),`\n`,(0,l.jsx)(e.p,{children:\"Now with filesets we can be all cute and fancy\"}),`\n`,(0,l.jsx)(i,{children:(0,l.jsxs)(e.p,{children:[`This example will have many parts omitted to keep the code easy to follow.\nTo see the real code, look at my `,(0,l.jsx)(e.a,{href:\"https://github.com/JRMurr/roc2nix/blob/main/lib/platformBuilders/buildRustPlatform.nix\",children:\"roc2nix repo\"}),\" where this came from\"]})}),`\n`,(0,l.jsx)(e.p,{children:\"First let's define a helper file for filtering files based on their extension\"}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"languageFilters.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# Note i generally don't like doing `with` at the top of a file\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# but since this will be only fileSet stuff it should be fine\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"with\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# helper func to take in a list of allowed\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# returns a function of `file => bool` to be used in a fileFilter.\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# true if file has suffix, false if not\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileSuffixes\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lists\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"any\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"s\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"hasSuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"s\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileSuffixes\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\");\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path, return a fileset of files in that path that are rust files, toml files, or cargo toml/lock\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": (\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"mainFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".rs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".toml\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ])\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"unions\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mainFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"+\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/Cargo.toml\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"+\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/Cargo.lock\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") ]\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    );\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path return a fileset with files ending with `.c`\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".c\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]) \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path return a fileset with files ending with `.roc`\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".roc\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]) \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:\"Now with that helper, we can do\"}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"buildRustPlatform.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./languageFilters.nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";};\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"compiledC\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# compile the c ...\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustBuiltLib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildRustPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# build the rust\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocCode\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"llvmPkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"rec\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pname\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"-\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"srcs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuiltLib\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"compiledC\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocCode\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  ];\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"sourceRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # NOTE: this link could be pulled into its own derivation for even better seperation\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # I only just realized this while making this post...\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    $LD -r -L \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuildName\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/lib \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cBuildName\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cHostDest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\" -lhost -o \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    mkdir -p $out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    cp \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\" $out/\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    cp -r \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocCode\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/. $out\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"  ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:`Now this is about as good as you can get.\nThe rust and c builds have no dependency on each other so you are free to modify the c without needing to rebuild the rust.`}),`\n`,(0,l.jsx)(e.p,{children:\"If you only change the roc code, you won't need to do any build (other than linking but in this example that could also be pulled out....).\"}),`\n`,(0,l.jsxs)(e.h2,{id:\"wrap-up\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#wrap-up\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"Wrap up\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Huge shoutout to \",(0,l.jsx)(e.a,{href:\"https://github.com/infinisil\",children:\"Silvan Mosberger\"}),\" from \",(0,l.jsx)(e.a,{href:\"https://www.tweag.io/\",children:\"Tweag\"}),` for bringing file sets to the main Nix library.\nHe was sponsored through my current employer `,(0,l.jsx)(e.a,{href:\"https://antithesis.com/\",children:\"Antithesis\"}),\" to develop this feature!\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I hope filesets make more people take a stab at making their own \",(0,l.jsx)(e.code,{children:\"*2nix\"}),\" builders, or just make their own builds more efficent.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I had a lot of fun working on \",(0,l.jsx)(e.a,{href:\"https://github.com/JRMurr/roc2nix/\",children:\"roc2nix\"}),`, it was my first time making a \"real\" nix library and I learned a lot along the way (not just file sets).\nIf you are interested in learning more about it check out the repo or let me know in the comments and I might make a separate blog diving into that (and hopefully some blogs on roc itself).`]})]})}}var A=g;function t(n,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+n+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return b;})();\n;return Component;","toc":[{"value":"What are file sets","url":"#what-are-file-sets","depth":2},{"value":"A Real Example","url":"#a-real-example","depth":2},{"value":"Wrap up","url":"#wrap-up","depth":2}],"frontMatter":{"readingTime":{"text":"6 min read","minutes":5.191666666666666,"time":311500,"words":1246},"slug":"efficient-nix-derivations-with-file-sets","fileName":"efficient-nix-derivations-with-file-sets.md","title":"Efficient Nix Derivations with File Sets","date":"2023-12-02T21:22:44.113Z","tags":["nix","nix-pkgs"],"draft":false,"summary":"Using nix's new file set API to make efficient derivations","images":[],"layout":"PostLayout"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.17916666666666667,"time":10750,"words":43},"slug":["default"],"fileName":"default.md","name":"John Murray","avatar":"/static/images/me.jpg","occupation":"Software Engineer","github":"https://github.com/JRMurr","twitter":"https://twitter.com/JRMurrCodes","mastodon":"https://hachyderm.io/@jrmurr","email":"johnreillymurray@gmail.com","date":null}],"series":null},"__N_SSG":true}