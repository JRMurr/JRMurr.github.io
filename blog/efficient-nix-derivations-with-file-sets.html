<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Efficient Nix Derivations with File Sets</title><meta name="robots" content="follow, index"/><meta name="description" content="Using nix&#x27;s new file set API to make efficient derivations"/><meta property="og:url" content="https://johns.codes/blog/efficient-nix-derivations-with-file-sets"/><meta property="og:type" content="article"/><meta property="og:site_name" content="John&#x27;s Codes"/><meta property="og:description" content="Using nix&#x27;s new file set API to make efficient derivations"/><meta property="og:title" content="Efficient Nix Derivations with File Sets"/><meta property="og:image" content="https://johns.codes/static/images/twitter-card.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/JRMurrCodes"/><meta name="twitter:title" content="Efficient Nix Derivations with File Sets"/><meta name="twitter:description" content="Using nix&#x27;s new file set API to make efficient derivations"/><meta name="twitter:image" content="https://johns.codes/static/images/twitter-card.png"/><meta property="article:published_time" content="2023-12-02T21:22:44.113Z"/><link rel="canonical" href="https://johns.codes/blog/efficient-nix-derivations-with-file-sets"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://johns.codes/blog/efficient-nix-derivations-with-file-sets"
  },
  "headline": "Efficient Nix Derivations with File Sets",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://johns.codes/static/images/twitter-card.png"
    }
  ],
  "datePublished": "2023-12-02T21:22:44.113Z",
  "dateModified": "2023-12-02T21:22:44.113Z",
  "author": [
    {
      "@type": "Person",
      "name": "John Murray"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "John Murray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://johns.codes/static/images/logo.png"
    }
  },
  "description": "Using nix's new file set API to make efficient derivations"
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/ff7a91e18d57a2d6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff7a91e18d57a2d6.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-a0fb203be75c9eb6.js" defer=""></script><script src="/_next/static/chunks/main-b77bb48dcc3828e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-861f57e6bedfde14.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/675-374a5a75205d32da.js" defer=""></script><script src="/_next/static/chunks/266-365d5fff0af19ac8.js" defer=""></script><script src="/_next/static/chunks/545-c9bf5496ebd361fd.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-c8a468ed53b4c5d2.js" defer=""></script><script src="/_next/static/_FHim0G2RtBJmEIVqQhwr/_buildManifest.js" defer=""></script><script src="/_next/static/_FHim0G2RtBJmEIVqQhwr/_ssgManifest.js" defer=""></script><script src="/_next/static/_FHim0G2RtBJmEIVqQhwr/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="John&#x27;s Codes" href="/"><div class="flex items-center justify-between"><div class="hidden h-6 text-2xl font-semibold sm:block">John&#x27;s Codes</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/projects">Projects</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="w-8 h-8 p-1 ml-1 mr-1 rounded sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed flex-col hidden gap-3 right-8 bottom-8 md:hidden"><button aria-label="Scroll To Comment" type="button" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-4 md:space-y-2 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="flex justify-center items-center text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2023-12-02T21:22:44.113Z">Saturday, December 2, 2023</time><span class="mx-2">-</span><div class="flex items-center"><span class="ml-1">6 min read</span></div></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Efficient Nix Derivations with File Sets</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-4 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><details open=""><summary class="pt-2 pb-2 ml-6 text-xl font-bold">Table of Contents</summary><div class="ml-6"><ul><li class="false"><a href="#what-are-file-sets">What are file sets</a></li><li class="false"><a href="#a-real-example">A Real Example</a></li><li class="false"><a href="#wrap-up">Wrap up</a></li></ul></div></details>
<p>If you are using Nix to build your own packages you will eventually come across something like</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;my awesome pkg&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">        # I have no idea if this actually works (the gcc call bit)</span></div><div class="line"><span style="color:#F1FA8C">        # but the vibe is what I care about</span></div><div class="line"><span style="color:#F1FA8C">        gcc main.c -o my_program</span></div><div class="line"><span style="color:#F1FA8C">        mkdir -p $out</span></div><div class="line"><span style="color:#F1FA8C">        cp my_program $out</span></div><div class="line"><span style="color:#F1FA8C">    &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>The issue with the above is setting <code>src = ./.</code>, which makes <strong>ALL</strong> of the current directory an input to the derivation.
So if you have a readme file in this folder, changing that will cause this derivation to rebuild.</p>
<p>The build only really cares about <code>main.c</code> in this case so what can we do to fix this?</p>
<p>Back in the dark dark times of pre-Nixos 23.11, there were ways to do this kind of filtering but IMO they were kinda confusing and
I never quite got it to work right so I just stuck with <code>src = ./.</code></p>
<p>Now with 23.11 we have <a target="_blank" rel="noopener noreferrer" href="https://www.tweag.io/blog/2023-11-28-file-sets/">filesets</a>, which makes filtering and adding files much simpler.</p>
<h2 id="what-are-file-sets"><a href="#what-are-file-sets" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>What are file sets</h2>
<p>I would recommend checking out the <a target="_blank" rel="noopener noreferrer" href="https://nixos.org/manual/nixpkgs/unstable/#sec-functions-library-fileset">docs</a> or <a target="_blank" rel="noopener noreferrer" href="https://nix.dev/tutorials/file-sets">official tutorial</a>, but for a TLDR, you can do the following</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">fs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">fileset</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">baseSrc</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">unions</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">./Makefile</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./src</span><span style="color:#F8F8F2"> ];</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">filterMarkdownFiles</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">fileFilter</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">file</span><span style="color:#F8F8F2">: </span><span style="color:#FFB86C">hasSuffix</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;.md&quot;</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">file</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">name</span><span style="color:#F8F8F2">) </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">removedMarkedDown</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">difference</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseSrc</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">filterMarkdownFiles</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#FF79C6">in</span></div><div class="line"><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;my awesome pkg&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">toSource</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">root</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">fileset</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">removedMarkedDown</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">       # call make or w/e you want</span></div><div class="line"><span style="color:#F1FA8C">    &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>Now with this setup, we have a &quot;base&quot; file set of <code>[ ./Makefile ./src ]</code> then with <code>fs.difference</code> we can remove all files that are markdown with the <code>filterMarkdownFiles</code> filter.</p>
<h2 id="a-real-example"><a href="#a-real-example" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>A Real Example</h2>
<p>Recently I started messing around with the language <a target="_blank" rel="noopener noreferrer" href="https://www.roc-lang.org/">Roc</a>. If you haven&#x27;t heard of it, Roc is a new functional language heavily inspired by Elm.
It&#x27;s fast but also very nice to use (though some rough edges since it&#x27;s pre-0.1.0).</p>
<p>One of its interesting ideas is that Roc needs your app to pick what <a target="_blank" rel="noopener noreferrer" href="https://www.roc-lang.org/platforms">platform</a> to run on.
A platform would be written in something like rust, zig, c, etc.
The platform provides roc APIs for things like managing memory, making network requests, printing to stdout, and other IO-like actions.
Right now the two most widely used are a <a target="_blank" rel="noopener noreferrer" href="https://github.com/roc-lang/basic-cli">cli platform</a> and <a target="_blank" rel="noopener noreferrer" href="https://github.com/roc-lang/basic-webserver">webserver platform</a></p>
<p>This is really neat but brings an issue for developing a platform along with the roc code needed to define the platform API.
You need to compile the &quot;platform code&quot; (ie rust + some c), do w/e linking is needed for that, then distribute that with the roc source code.
The roc cli will do this for you when developing but it doesn&#x27;t work as nicely to compile just the platform with nix.</p>
<p>For example, <a target="_blank" rel="noopener noreferrer" href="https://github.com/roc-lang/roc/tree/main/examples/platform-switching/rust-platform">this</a> is one of the sample platforms</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">shell</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">❯ exa --tree --level 2</span></div><div class="line"><span style="color:#8BE9FD">.</span></div><div class="line"><span style="color:#F8F8F2">├── Cargo.lock</span></div><div class="line"><span style="color:#F8F8F2">├── Cargo.toml</span></div><div class="line"><span style="color:#F8F8F2">├── host.c</span></div><div class="line"><span style="color:#F8F8F2">├── main.roc</span></div><div class="line"><span style="color:#F8F8F2">├── rust-toolchain.toml</span></div><div class="line"><span style="color:#F8F8F2">└── src</span></div><div class="line"><span style="color:#F8F8F2">   ├── glue.rs</span></div><div class="line"><span style="color:#F8F8F2">   ├── lib.rs</span></div><div class="line"><span style="color:#F8F8F2">   └── main.rs</span></div></code></div></pre></div>
<p>To build this platform you need to run a <code>cargo build --lib ...</code> on the rust code, compile the <code>host.c</code> file,
link those two object files together, and then finally distribute the linked object file with the roc code.</p>
<p>so after all those steps, it should look something like</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">shell</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">❯ exa --tree </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">compiled folder</span><span style="color:#FF79C6">&gt;</span></div><div class="line"><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">compiled folder</span><span style="color:#FF79C6">&gt;</span></div><div class="line"><span style="color:#F8F8F2">├── linux-x64.o</span></div><div class="line"><span style="color:#F8F8F2">└── main.roc</span></div></code></div></pre></div>
<p>The naive approach would probably be something like</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#50FA7B">compiledC</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># compile the c ...</span></div><div class="line"><span style="color:#F8F8F2">};</span></div><div class="line"><span style="color:#50FA7B">rustBuiltLib</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">buildRustPackage</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># build the rust</span></div><div class="line"><span style="color:#F8F8F2">};</span></div><div class="line"><span style="color:#FF79C6">in</span></div><div class="line"><span style="color:#FFB86C">llvmPkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">rec</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">pname</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">-</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">version</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">srcs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">rustBuiltLib</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">compiledC</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2"> </span><span style="color:#6272A4"># for the roc code</span></div><div class="line"><span style="color:#F8F8F2">  ];</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">sourceRoot</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;.&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">    # link the rust and c files</span></div><div class="line"><span style="color:#F1FA8C">    # copy roc and linked object out</span></div><div class="line"><span style="color:#F1FA8C">  &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>while this works, it also sucks. <strong>ANY</strong> change to the files will cause all 3 derivations to be rebuilt.</p>
<p>Now with filesets we can be all cute and fancy</p>
<div class="grid place-content-center"><div class="dark:bg-gray-800 bg-gray-100 rounded"><div class="box-content px-3 py-0"><p>This example will have many parts omitted to keep the code easy to follow.
To see the real code, look at my <a target="_blank" rel="noopener noreferrer" href="https://github.com/JRMurr/roc2nix/blob/main/lib/platformBuilders/buildRustPlatform.nix">roc2nix repo</a> where this came from</p></div></div></div>
<p>First let&#x27;s define a helper file for filtering files based on their extension</p>
<div class="remark-code-title">languageFilters.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span><span style="color:#FFB86C">lib</span><span style="color:#F8F8F2">}:</span></div><div class="line"></div><div class="line"><span style="color:#6272A4"># Note i generally don&#x27;t like doing `with` at the top of a file</span></div><div class="line"><span style="color:#6272A4"># but since this will be only fileSet stuff it should be fine</span></div><div class="line"><span style="color:#FF79C6">with</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">fileset</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># helper func to take in a list of allowed</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># returns a function of `file =&gt; bool` to be used in a fileFilter.</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># true if file has suffix, false if not</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">fileHasAnySuffix</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fileSuffixes</span><span style="color:#F8F8F2">: </span><span style="color:#FFB86C">file</span><span style="color:#F8F8F2">: (</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lists</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">any</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">s</span><span style="color:#F8F8F2">: </span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">hasSuffix</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">s</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">file</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">name</span><span style="color:#F8F8F2">) </span><span style="color:#FFB86C">fileSuffixes</span><span style="color:#F8F8F2">);</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># given a basePath src path, return a fileset of files in that path that are rust files, toml files, or cargo toml/lock</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">rustFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">: (</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">mainFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fileFilter</span></div><div class="line"><span style="color:#F8F8F2">            (</span><span style="color:#FFB86C">fileHasAnySuffix</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">&quot;.rs&quot;</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;.toml&quot;</span><span style="color:#F8F8F2"> ])</span></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">in</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#FFB86C">unions</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">mainFilter</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;/Cargo.toml&quot;</span><span style="color:#F8F8F2">) (</span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;/Cargo.lock&quot;</span><span style="color:#F8F8F2">) ]</span></div><div class="line"><span style="color:#F8F8F2">    );</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># given a basePath src path return a fileset with files ending with `.c`</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">cFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">: </span><span style="color:#FFB86C">fileFilter</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">fileHasAnySuffix</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">&quot;.c&quot;</span><span style="color:#F8F8F2"> ]) </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># given a basePath src path return a fileset with files ending with `.roc`</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">rocFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">: </span><span style="color:#FFB86C">fileFilter</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">fileHasAnySuffix</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">&quot;.roc&quot;</span><span style="color:#F8F8F2"> ]) </span><span style="color:#FFB86C">basePath</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#FF79C6">in</span></div><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">rustFilter</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">cFilter</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">rocFilter</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>Now with that helper, we can do</p>
<div class="remark-code-title">buildRustPlatform.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">fs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">fileset</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">languageFilters</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD">import</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./languageFilters.nix</span><span style="color:#F8F8F2"> {</span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">lib</span><span style="color:#F8F8F2">;};</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">baseDir</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">compiledC</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">toSource</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">root</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">fileset</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">languageFilters</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">cFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      };</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#6272A4"># compile the c ...</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">rustBuiltLib</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">buildRustPackage</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">toSource</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">root</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">fileset</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">languageFilters</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">rustFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      };</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#6272A4"># build the rust</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">rocCode</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">fs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">toSource</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">root</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">fileset</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">languageFilters</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">rocFilter</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">baseDir</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"><span style="color:#FF79C6">in</span></div><div class="line"><span style="color:#FFB86C">llvmPkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">rec</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">pname</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">-</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">version</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">srcs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">rustBuiltLib</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">compiledC</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">rocCode</span></div><div class="line"><span style="color:#F8F8F2">  ];</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">sourceRoot</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;.&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">    # NOTE: this link could be pulled into its own derivation for even better seperation</span></div><div class="line"><span style="color:#F1FA8C">    # I only just realized this while making this post...</span></div><div class="line"><span style="color:#F1FA8C">    $LD -r -L </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">rustBuildName</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/lib </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">cBuildName</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">cHostDest</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> -lhost -o </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">host_dest</span><span style="color:#FF79C6">}</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">    mkdir -p $out</span></div><div class="line"><span style="color:#F1FA8C">    cp </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">host_dest</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> $out/</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">host_dest</span><span style="color:#FF79C6">}</span></div><div class="line"><span style="color:#F1FA8C">    cp -r </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">rocCode</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/. $out</span></div><div class="line"><span style="color:#F1FA8C">  &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>Now this is about as good as you can get.
The rust and c builds have no dependency on each other so you are free to modify the c without needing to rebuild the rust.</p>
<p>If you only change the roc code, you won&#x27;t need to do any build (other than linking but in this example that could also be pulled out....).</p>
<h2 id="wrap-up"><a href="#wrap-up" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Wrap up</h2>
<p>Huge shoutout to <a target="_blank" rel="noopener noreferrer" href="https://github.com/infinisil">Silvan Mosberger</a> from <a target="_blank" rel="noopener noreferrer" href="https://www.tweag.io/">Tweag</a> for bringing file sets to the main Nix library.
He was sponsored through my current employer <a target="_blank" rel="noopener noreferrer" href="https://antithesis.com/">Antithesis</a> to develop this feature!</p>
<p>I hope filesets make more people take a stab at making their own <code>*2nix</code> builders, or just make their own builds more efficent.</p>
<p>I had a lot of fun working on <a target="_blank" rel="noopener noreferrer" href="https://github.com/JRMurr/roc2nix/">roc2nix</a>, it was my first time making a &quot;real&quot; nix library and I learned a lot along the way (not just file sets).
If you are interested in learning more about it check out the repo or let me know in the comments and I might make a separate blog diving into that (and hopefully some blogs on roc itself).</p></div></div></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer me" href="https://github.com/JRMurr"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer me" href="https://twitter.com/JRMurrCodes"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer me" href="https://hachyderm.io/@jrmurr"><span class="sr-only">mastodon</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-8 w-8"><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer me" href="/feed.xml"><span class="sr-only">rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.912 24.912" style="enable-background:new 0 0 24.912 24.912" xml:space="preserve" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M3.692 17.517A3.696 3.696 0 0 0 0 21.211C0 23.244 1.656 24.9 3.692 24.9s3.694-1.657 3.694-3.689a3.697 3.697 0 0 0-3.694-3.694z"></path><path d="M.384 8.142A.386.386 0 0 0 0 8.527v4.688c0 .211.173.383.384.383 6.02 0 10.919 4.898 10.919 10.92 0 .209.171.383.384.383h4.705a.385.385 0 0 0 .387-.383l-.018-.121C16.692 15.423 9.37 8.142.384 8.142z"></path><path d="M24.89 24.397C24.825 10.936 13.854.011.384.011A.385.385 0 0 0 0 .397v4.824c0 .212.173.383.384.383 10.429 0 18.913 8.486 18.913 18.914 0 .209.172.383.382.383h4.845a.39.39 0 0 0 .388-.383l-.022-.121z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>John Murray</div><div> • </div><div>© 2024</div><div> • </div><a href="/">John&#x27;s Codes</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var h=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var F=n=\u003ec(n,\"__esModule\",{value:!0});var u=(n,s)=\u003e()=\u003e(s||n((s={exports:{}}).exports,s),s.exports),f=(n,s)=\u003e{F(n);for(var r in s)c(n,r,{get:s[r],enumerable:!0})},v=(n,s,r)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let e of y(s))!C.call(n,e)\u0026\u0026e!==\"default\"\u0026\u0026c(n,e,{get:()=\u003es[e],enumerable:!(r=p(s,e))||r.enumerable});return n},N=n=\u003ev(F(c(n!=null?h(m(n)):{},\"default\",n\u0026\u0026n.__esModule\u0026\u0026\"default\"in n?{get:()=\u003en.default,enumerable:!0}:{value:n,enumerable:!0})),n);var d=u((k,a)=\u003e{a.exports=_jsx_runtime});var b={};f(b,{default:()=\u003eA,frontmatter:()=\u003eB});var l=N(d()),B={title:\"Efficient Nix Derivations with File Sets\",date:new Date(1701552164113),tags:[\"nix\",\"nix-pkgs\",\"roc\"],draft:!1,summary:\"Using nix's new file set API to make efficient derivations\",images:[],layout:\"PostLayout\"};function g(n={}){let{wrapper:s}=n.components||{};return s?(0,l.jsx)(s,Object.assign({},n,{children:(0,l.jsx)(r,{})})):r();function r(){let e=Object.assign({p:\"p\",pre:\"pre\",div:\"div\",code:\"code\",span:\"span\",strong:\"strong\",a:\"a\",h2:\"h2\"},n.components),{TOCInline:o,Note:i}=e;return i||t(\"Note\",!0),o||t(\"TOCInline\",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o,{toc:n.toc,asDisclosure:!0}),`\n`,(0,l.jsx)(e.p,{children:\"If you are using Nix to build your own packages you will eventually come across something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"my awesome pkg\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        # I have no idea if this actually works (the gcc call bit)\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        # but the vibe is what I care about\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        gcc main.c -o my_program\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        mkdir -p $out\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"        cp my_program $out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The issue with the above is setting \",(0,l.jsx)(e.code,{children:\"src = ./.\"}),\", which makes \",(0,l.jsx)(e.strong,{children:\"ALL\"}),` of the current directory an input to the derivation.\nSo if you have a readme file in this folder, changing that will cause this derivation to rebuild.`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The build only really cares about \",(0,l.jsx)(e.code,{children:\"main.c\"}),\" in this case so what can we do to fix this?\"]}),`\n`,(0,l.jsxs)(e.p,{children:[`Back in the dark dark times of pre-Nixos 23.11, there were ways to do this kind of filtering but IMO they were kinda confusing and\nI never quite got it to work right so I just stuck with `,(0,l.jsx)(e.code,{children:\"src = ./.\"})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Now with 23.11 we have \",(0,l.jsx)(e.a,{href:\"https://www.tweag.io/blog/2023-11-28-file-sets/\",children:\"filesets\"}),\", which makes filtering and adding files much simpler.\"]}),`\n`,(0,l.jsxs)(e.h2,{id:\"what-are-file-sets\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#what-are-file-sets\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"What are file sets\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I would recommend checking out the \",(0,l.jsx)(e.a,{href:\"https://nixos.org/manual/nixpkgs/unstable/#sec-functions-library-fileset\",children:\"docs\"}),\" or \",(0,l.jsx)(e.a,{href:\"https://nix.dev/tutorials/file-sets\",children:\"official tutorial\"}),\", but for a TLDR, you can do the following\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"baseSrc\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"unions\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./Makefile\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"filterMarkdownFiles\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"hasSuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".md\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"removedMarkedDown\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"difference\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseSrc\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"filterMarkdownFiles\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"my awesome pkg\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"removedMarkedDown\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"       # call make or w/e you want\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:['Now with this setup, we have a \"base\" file set of ',(0,l.jsx)(e.code,{children:\"[ ./Makefile ./src ]\"}),\" then with \",(0,l.jsx)(e.code,{children:\"fs.difference\"}),\" we can remove all files that are markdown with the \",(0,l.jsx)(e.code,{children:\"filterMarkdownFiles\"}),\" filter.\"]}),`\n`,(0,l.jsxs)(e.h2,{id:\"a-real-example\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#a-real-example\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"A Real Example\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Recently I started messing around with the language \",(0,l.jsx)(e.a,{href:\"https://www.roc-lang.org/\",children:\"Roc\"}),`. If you haven't heard of it, Roc is a new functional language heavily inspired by Elm.\nIt's fast but also very nice to use (though some rough edges since it's pre-0.1.0).`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"One of its interesting ideas is that Roc needs your app to pick what \",(0,l.jsx)(e.a,{href:\"https://www.roc-lang.org/platforms\",children:\"platform\"}),` to run on.\nA platform would be written in something like rust, zig, c, etc.\nThe platform provides roc APIs for things like managing memory, making network requests, printing to stdout, and other IO-like actions.\nRight now the two most widely used are a `,(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/basic-cli\",children:\"cli platform\"}),\" and \",(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/basic-webserver\",children:\"webserver platform\"})]}),`\n`,(0,l.jsx)(e.p,{children:`This is really neat but brings an issue for developing a platform along with the roc code needed to define the platform API.\nYou need to compile the \"platform code\" (ie rust + some c), do w/e linking is needed for that, then distribute that with the roc source code.\nThe roc cli will do this for you when developing but it doesn't work as nicely to compile just the platform with nix.`}),`\n`,(0,l.jsxs)(e.p,{children:[\"For example, \",(0,l.jsx)(e.a,{href:\"https://github.com/roc-lang/roc/tree/main/examples/platform-switching/rust-platform\",children:\"this\"}),\" is one of the sample platforms\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"shell\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u276F exa --tree --level 2\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\".\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 Cargo.lock\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 Cargo.toml\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 host.c\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 main.roc\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 rust-toolchain.toml\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 src\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u251C\\u2500\\u2500 glue.rs\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u251C\\u2500\\u2500 lib.rs\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u2514\\u2500\\u2500 main.rs\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"To build this platform you need to run a \",(0,l.jsx)(e.code,{children:\"cargo build --lib ...\"}),\" on the rust code, compile the \",(0,l.jsx)(e.code,{children:\"host.c\"}),` file,\nlink those two object files together, and then finally distribute the linked object file with the roc code.`]}),`\n`,(0,l.jsx)(e.p,{children:\"so after all those steps, it should look something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"shell\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u276F exa --tree \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003c\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"compiled folder\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003e\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003c\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"compiled folder\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003e\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 linux-x64.o\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 main.roc\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:\"The naive approach would probably be something like\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"compiledC\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# compile the c ...\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"};\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustBuiltLib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildRustPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# build the rust\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"};\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"llvmPkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"rec\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pname\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"-\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"srcs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuiltLib\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"compiledC\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# for the roc code\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  ];\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"sourceRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # link the rust and c files\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # copy roc and linked object out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"  ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"while this works, it also sucks. \",(0,l.jsx)(e.strong,{children:\"ANY\"}),\" change to the files will cause all 3 derivations to be rebuilt.\"]}),`\n`,(0,l.jsx)(e.p,{children:\"Now with filesets we can be all cute and fancy\"}),`\n`,(0,l.jsx)(i,{children:(0,l.jsxs)(e.p,{children:[`This example will have many parts omitted to keep the code easy to follow.\nTo see the real code, look at my `,(0,l.jsx)(e.a,{href:\"https://github.com/JRMurr/roc2nix/blob/main/lib/platformBuilders/buildRustPlatform.nix\",children:\"roc2nix repo\"}),\" where this came from\"]})}),`\n`,(0,l.jsx)(e.p,{children:\"First let's define a helper file for filtering files based on their extension\"}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"languageFilters.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# Note i generally don't like doing `with` at the top of a file\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# but since this will be only fileSet stuff it should be fine\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"with\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# helper func to take in a list of allowed\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# returns a function of `file =\u003e bool` to be used in a fileFilter.\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# true if file has suffix, false if not\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileSuffixes\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lists\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"any\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"s\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"hasSuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"s\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"file\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileSuffixes\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\");\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path, return a fileset of files in that path that are rust files, toml files, or cargo toml/lock\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": (\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"mainFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".rs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".toml\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ])\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"unions\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mainFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"+\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/Cargo.toml\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"+\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/Cargo.lock\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") ]\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    );\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path return a fileset with files ending with `.c`\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".c\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]) \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# given a basePath src path return a fileset with files ending with `.roc`\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\": \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileHasAnySuffix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".roc\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]) \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"basePath\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:\"Now with that helper, we can do\"}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"buildRustPlatform.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./languageFilters.nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";};\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"compiledC\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# compile the c ...\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rustBuiltLib\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildRustPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# build the rust\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"rocCode\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"fs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"toSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"root\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fileset\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"languageFilters\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocFilter\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"baseDir\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"llvmPkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"rec\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pname\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"-\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"srcs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuiltLib\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"compiledC\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocCode\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  ];\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"sourceRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\".\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # NOTE: this link could be pulled into its own derivation for even better seperation\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    # I only just realized this while making this post...\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    $LD -r -L \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rustBuildName\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/lib \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cBuildName\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"cHostDest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\" -lhost -o \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    mkdir -p $out\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    cp \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\" $out/\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"host_dest\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"    cp -r \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"rocCode\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/. $out\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"  ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:`Now this is about as good as you can get.\nThe rust and c builds have no dependency on each other so you are free to modify the c without needing to rebuild the rust.`}),`\n`,(0,l.jsx)(e.p,{children:\"If you only change the roc code, you won't need to do any build (other than linking but in this example that could also be pulled out....).\"}),`\n`,(0,l.jsxs)(e.h2,{id:\"wrap-up\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#wrap-up\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"Wrap up\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Huge shoutout to \",(0,l.jsx)(e.a,{href:\"https://github.com/infinisil\",children:\"Silvan Mosberger\"}),\" from \",(0,l.jsx)(e.a,{href:\"https://www.tweag.io/\",children:\"Tweag\"}),` for bringing file sets to the main Nix library.\nHe was sponsored through my current employer `,(0,l.jsx)(e.a,{href:\"https://antithesis.com/\",children:\"Antithesis\"}),\" to develop this feature!\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I hope filesets make more people take a stab at making their own \",(0,l.jsx)(e.code,{children:\"*2nix\"}),\" builders, or just make their own builds more efficent.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I had a lot of fun working on \",(0,l.jsx)(e.a,{href:\"https://github.com/JRMurr/roc2nix/\",children:\"roc2nix\"}),`, it was my first time making a \"real\" nix library and I learned a lot along the way (not just file sets).\nIf you are interested in learning more about it check out the repo or let me know in the comments and I might make a separate blog diving into that (and hopefully some blogs on roc itself).`]})]})}}var A=g;function t(n,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+n+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return b;})();\n;return Component;","toc":[{"value":"What are file sets","url":"#what-are-file-sets","depth":2},{"value":"A Real Example","url":"#a-real-example","depth":2},{"value":"Wrap up","url":"#wrap-up","depth":2}],"frontMatter":{"readingTime":{"text":"6 min read","minutes":5.191666666666666,"time":311500,"words":1246},"slug":"efficient-nix-derivations-with-file-sets","fileName":"efficient-nix-derivations-with-file-sets.md","title":"Efficient Nix Derivations with File Sets","date":"2023-12-02T21:22:44.113Z","tags":["nix","nix-pkgs","roc"],"draft":false,"summary":"Using nix's new file set API to make efficient derivations","images":[],"layout":"PostLayout"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.17916666666666667,"time":10750,"words":43},"slug":["default"],"fileName":"default.md","name":"John Murray","avatar":"/static/images/me.jpg","occupation":"Software Engineer","github":"https://github.com/JRMurr","twitter":"https://twitter.com/JRMurrCodes","mastodon":"https://hachyderm.io/@jrmurr","email":"johnreillymurray@gmail.com","date":null}],"series":null},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["efficient-nix-derivations-with-file-sets"]},"buildId":"_FHim0G2RtBJmEIVqQhwr","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>