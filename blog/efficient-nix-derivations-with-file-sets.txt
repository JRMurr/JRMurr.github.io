3:I[5613,[],""]
5:I[1778,[],""]
6:I[8029,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],"ThemeProviders"]
7:I[5935,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],""]
8:I[9266,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],"KBarSearchProvider"]
9:I[5250,["250","static/chunks/250-a30085ccab20449f.js","749","static/chunks/749-ed776d54eb5c7205.js","797","static/chunks/app/blog/%5B...slug%5D/page-fd9b73ee915812e8.js"],""]
a:I[2146,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],"KBarButton"]
b:I[5021,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],""]
c:I[123,["250","static/chunks/250-a30085ccab20449f.js","781","static/chunks/781-9238b26c3a132736.js","185","static/chunks/app/layout-9608048ecb38eb6e.js"],""]
4:["slug","efficient-nix-derivations-with-file-sets","c"]
d:T44f,M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z0:["eDPdjg8oJpDO6n8_m9oD4",[[["",{"children":["blog",{"children":[["slug","efficient-nix-derivations-with-file-sets","c"],{"children":["__PAGE__?{\"slug\":[\"efficient-nix-derivations-with-file-sets\"]}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","efficient-nix-derivations-with-file-sets","c"],{"children":["__PAGE__",{},["$L1","$L2",null]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/14fb540b7a3ad639.css","precedence":"next","crossOrigin":""}]]}]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},[null,["$","html",null,{"lang":"en-us","className":"__variable_587f35 scroll-smooth","suppressHydrationWarning":true,"children":[["$","link",null,{"rel":"apple-touch-icon","sizes":"76x76","href":"/static/favicons/apple-touch-icon.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"32x32","href":"/static/favicons/favicon-32x32.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"16x16","href":"/static/favicons/favicon-16x16.png"}],["$","link",null,{"rel":"manifest","href":"/static/favicons/site.webmanifest"}],["$","link",null,{"rel":"mask-icon","href":"/static/favicons/safari-pinned-tab.svg","color":"#5bbad5"}],["$","meta",null,{"name":"msapplication-TileColor","content":"#000000"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: light)","content":"#fff"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: dark)","content":"#000"}],["$","link",null,{"rel":"alternate","type":"application/rss+xml","href":"/feed.xml"}],["$","body",null,{"className":"bg-white text-black antialiased dark:bg-gray-950 dark:text-white","children":["$","$L6",null,{"children":[[["$","$L7",null,{"strategy":"lazyOnload","data-domain":"johns.codes","data-api":"$undefined","src":"https://plausible.io/js/plausible.js"}],["$","$L7",null,{"strategy":"lazyOnload","id":"plausible-script","children":"\n            window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }\n        "}]],["$","section",null,{"className":"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0","children":["$","div",null,{"className":"flex h-screen flex-col justify-between font-sans","children":[["$","$L8",null,{"kbarConfig":{"searchDocumentsPath":"search.json"},"children":[["$","header",null,{"className":"flex items-center justify-between py-10","children":[["$","div",null,{"children":["$","$L9",null,{"href":"/","aria-label":"John's Codes","children":["$","div",null,{"className":"flex items-center justify-between","children":["$","div",null,{"className":"hidden h-6 text-2xl font-semibold sm:block","children":"John's Codes"}]}]}]}],["$","div",null,{"className":"flex items-center space-x-4 leading-5 sm:space-x-6","children":[[["$","$L9",null,{"href":"/blog","className":"hidden font-medium text-gray-900 dark:text-gray-100 sm:block","children":"Blog"}],["$","$L9",null,{"href":"/tags","className":"hidden font-medium text-gray-900 dark:text-gray-100 sm:block","children":"Tags"}],["$","$L9",null,{"href":"/projects","className":"hidden font-medium text-gray-900 dark:text-gray-100 sm:block","children":"Projects"}],["$","$L9",null,{"href":"/about","className":"hidden font-medium text-gray-900 dark:text-gray-100 sm:block","children":"About"}]],["$","$La",null,{"aria-label":"Search","children":["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","fill":"none","viewBox":"0 0 24 24","strokeWidth":1.5,"stroke":"currentColor","className":"h-6 w-6 text-gray-900 dark:text-gray-100","children":["$","path",null,{"strokeLinecap":"round","strokeLinejoin":"round","d":"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"}]}]}],["$","$Lb",null,{}],["$","$Lc",null,{}]]}]]}],["$","main",null,{"className":"mb-auto","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"className":"flex flex-col items-start justify-start md:mt-24 md:flex-row md:items-center md:justify-center md:space-x-6","children":[["$","div",null,{"className":"space-x-2 pb-8 pt-6 md:space-y-5","children":["$","h1",null,{"className":"text-6xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 md:border-r-2 md:px-6 md:text-8xl md:leading-14","children":"404"}]}],["$","div",null,{"className":"max-w-md","children":[["$","p",null,{"className":"mb-4 text-xl font-bold leading-normal md:text-2xl","children":"Sorry we couldn't find this page."}],["$","p",null,{"className":"mb-8","children":"But dont worry, you can find plenty of other things on our homepage."}],["$","$L9",null,{"href":"/","className":"focus:shadow-outline-blue inline rounded-lg border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium leading-5 text-white shadow transition-colors duration-150 hover:bg-blue-700 focus:outline-none dark:hover:bg-blue-500","children":"Back to homepage"}]]}]]}],"notFoundStyles":[],"styles":null}]}]]}],["$","footer",null,{"children":["$","div",null,{"className":"mt-16 flex flex-col items-center","children":[["$","div",null,{"className":"mb-3 flex space-x-4","children":[null,["$","a",null,{"className":"text-sm text-gray-500 transition hover:text-gray-600","target":"_blank","rel":"noopener noreferrer","href":"https://github.com/JRMurr","children":[["$","span",null,{"className":"sr-only","children":"github"}],["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","className":"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6","children":["$","path",null,{"d":"M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"}]}]]}],["$","a",null,{"className":"text-sm text-gray-500 transition hover:text-gray-600","target":"_blank","rel":"noopener noreferrer","href":"https://twitter.com/JRMurrCodes","children":[["$","span",null,{"className":"sr-only","children":"twitter"}],["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","className":"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6","children":["$","path",null,{"d":"M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"}]}]]}],["$","a",null,{"className":"text-sm text-gray-500 transition hover:text-gray-600","target":"_blank","rel":"noopener noreferrer","href":"https://hachyderm.io/@jrmurr","children":[["$","span",null,{"className":"sr-only","children":"mastodon"}],["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","className":"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6","children":["$","path",null,{"d":"$d"}]}]]}],["$","a",null,{"className":"text-sm text-gray-500 transition hover:text-gray-600","target":"_blank","rel":"noopener noreferrer","href":"/feed.xml","children":[["$","span",null,{"className":"sr-only","children":"rss"}],["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","className":"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6","children":[["$","path",null,{"d":"M3.692 17.517A3.696 3.696 0 0 0 0 21.211C0 23.244 1.656 24.9 3.692 24.9s3.694-1.657 3.694-3.689a3.697 3.697 0 0 0-3.694-3.694z"}],["$","path",null,{"d":"M.384 8.142A.386.386 0 0 0 0 8.527v4.688c0 .211.173.383.384.383 6.02 0 10.919 4.898 10.919 10.92 0 .209.171.383.384.383h4.705a.385.385 0 0 0 .387-.383l-.018-.121C16.692 15.423 9.37 8.142.384 8.142z"}],["$","path",null,{"d":"M24.89 24.397C24.825 10.936 13.854.011.384.011A.385.385 0 0 0 0 .397v4.824c0 .212.173.383.384.383 10.429 0 18.913 8.486 18.913 18.914 0 .209.172.383.382.383h4.845a.39.39 0 0 0 .388-.383l-.022-.121z"}]]}]]}]]}],["$","div",null,{"className":"mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400","children":[["$","div",null,{"children":"John Murray"}],["$","div",null,{"children":" • "}],["$","div",null,{"children":"© 2024"}],["$","div",null,{"children":" • "}],["$","$L9",null,{"href":"/","children":"John's Codes"}]]}]]}]}]]}]}]]}]}]]}],null]],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/895662d5d095c22a.css","precedence":"next","crossOrigin":""}]],"$Le"]]]]
f:I[144,["250","static/chunks/250-a30085ccab20449f.js","749","static/chunks/749-ed776d54eb5c7205.js","797","static/chunks/app/blog/%5B...slug%5D/page-fd9b73ee915812e8.js"],""]
10:I[2502,["250","static/chunks/250-a30085ccab20449f.js","749","static/chunks/749-ed776d54eb5c7205.js","797","static/chunks/app/blog/%5B...slug%5D/page-fd9b73ee915812e8.js"],""]
11:I[4282,["250","static/chunks/250-a30085ccab20449f.js","749","static/chunks/749-ed776d54eb5c7205.js","797","static/chunks/app/blog/%5B...slug%5D/page-fd9b73ee915812e8.js"],""]
12:I[4970,["250","static/chunks/250-a30085ccab20449f.js","749","static/chunks/749-ed776d54eb5c7205.js","797","static/chunks/app/blog/%5B...slug%5D/page-fd9b73ee915812e8.js"],""]
2:[["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BlogPosting\",\"headline\":\"Efficient Nix Derivations with File Sets\",\"datePublished\":\"2023-12-02T21:22:44.113Z\",\"dateModified\":\"2023-12-02T21:22:44.113Z\",\"description\":\"Using nix's new file set API to make efficient derivations\",\"author\":[{\"@type\":\"Person\",\"name\":\"John Murray\"}]}"}}],["$","section",null,{"className":"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0","children":[["$","$Lf",null,{}],["$","article",null,{"children":["$","div",null,{"children":[["$","header",null,{"children":["$","div",null,{"className":"space-y-1 border-b border-gray-200 pb-10 text-center dark:border-gray-700","children":[["$","dl",null,{"children":["$","div",null,{"children":[["$","dt",null,{"className":"sr-only","children":"Published on"}],["$","dd",null,{"className":"text-base font-medium leading-6 text-gray-500 dark:text-gray-400","children":[["$","time",null,{"dateTime":"2023-12-02T21:22:44.113Z","children":"December 2, 2023"}],["$","span",null,{"className":"mx-2","children":"-"}],["$","span",null,{"className":"ml-1","children":[4," min read"]}]]}]]}]}],["$","div",null,{"children":["$","h1",null,{"className":"text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14","children":"Efficient Nix Derivations with File Sets"}]}]]}]}],["$","div",null,{"className":"grid-rows-[auto_1fr] divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:divide-y-0","children":[["$","div",null,{"className":"divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0","children":[["$","div",null,{"className":"prose max-w-none pb-8 pt-10 dark:prose-invert","children":[["$","$L10",null,{"series":null,"currSlug":"efficient-nix-derivations-with-file-sets"}],[["$","details",null,{"open":true,"children":[["$","summary",null,{"className":"ml-6 pb-2 pt-2 text-xl font-bold","children":"Table of Contents"}],["$","div",null,{"className":"ml-6","children":["$","ul",null,{"className":"","children":[["$","li","0",{"children":[["$","a",null,{"href":"#what-are-file-sets","children":"What are file sets"}],null]}],["$","li","1",{"children":[["$","a",null,{"href":"#a-real-example","children":"A Real Example"}],null]}],["$","li","2",{"children":[["$","a",null,{"href":"#wrap-up","children":"Wrap up"}],null]}]]}]}]]}],["$","p",null,{"children":"If you are using Nix to build your own packages you will eventually come across something like"}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"stdenv"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"mkDerivation"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    name"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \"my awesome pkg\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    buildPhase"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ''"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"        # I have no idea if this actually works (the gcc call bit)"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"        # but the vibe is what I care about"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"        gcc main.c -o my_program"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"        mkdir -p $out"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"        cp my_program $out"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    ''"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"}"}]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":["The issue with the above is setting ",["$","code",null,{"children":"src = ./."}],", which makes ",["$","strong",null,{"children":"ALL"}]," of the current directory an input to the derivation. So if you have a readme file in this folder, changing that will cause this derivation to rebuild."]}],["$","p",null,{"children":["The build only really cares about ",["$","code",null,{"children":"main.c"}]," in this case so what can we do to fix this?"]}],["$","p",null,{"children":["Back in the dark dark times of pre-Nixos 23.11, there were ways to do this kind of filtering but IMO they were kinda confusing and I never quite got it to work right so I just stuck with ",["$","code",null,{"children":"src = ./."}]]}],["$","p",null,{"children":["Now with 23.11 we have ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.tweag.io/blog/2023-11-28-file-sets/","children":"filesets"}],", which makes filtering and adding files much simpler."]}],["$","h2",null,{"id":"what-are-file-sets","children":[["$","a",null,{"href":"#what-are-file-sets","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"icon icon-link"}]}],"What are file sets"]}],["$","p",null,{"children":["I would recommend checking out the ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://nixos.org/manual/nixpkgs/unstable/#sec-functions-library-fileset","children":"docs"}]," or ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://nix.dev/tutorials/file-sets","children":"official tutorial"}],", but for a TLDR, you can do the following"]}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"let"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" pkgs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"lib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileset"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    baseSrc"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"unions"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" [ "}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"./Makefile"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./src"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ];"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    filterMarkdownFiles"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileFilter"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" (file: "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"hasSuffix"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \".md\""}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" file"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"name"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":") "}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    removedMarkedDown"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"difference"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseSrc"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" filterMarkdownFiles"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"in"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"stdenv"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"mkDerivation"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    name"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \"my awesome pkg\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"toSource"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"        root"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"        fileset"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" removedMarkedDown"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"    };"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    buildPhase"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ''"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"       # call make or w/e you want"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    ''"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"}"}]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":["Now with this setup, we have a \"base\" file set of ",["$","code",null,{"children":"[ ./Makefile ./src ]"}]," then with ",["$","code",null,{"children":"fs.difference"}]," we can remove all files that are markdown with the ",["$","code",null,{"children":"filterMarkdownFiles"}]," filter."]}],["$","h2",null,{"id":"a-real-example","children":[["$","a",null,{"href":"#a-real-example","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"icon icon-link"}]}],"A Real Example"]}],["$","p",null,{"children":["Recently I started messing around with the language ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.roc-lang.org/","children":"Roc"}],". If you haven't heard of it, Roc is a new functional language heavily inspired by Elm. It's fast but also very nice to use (though some rough edges since it's pre-0.1.0)."]}],["$","p",null,{"children":["One of its interesting ideas is that Roc needs your app to pick what ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.roc-lang.org/platforms","children":"platform"}]," to run on. A platform would be written in something like rust, zig, c, etc. The platform provides roc APIs for things like managing memory, making network requests, printing to stdout, and other IO-like actions. Right now the two most widely used are a ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/roc-lang/basic-cli","children":"cli platform"}]," and ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/roc-lang/basic-webserver","children":"webserver platform"}]]}],["$","p",null,{"children":"This is really neat but brings an issue for developing a platform along with the roc code needed to define the platform API. You need to compile the \"platform code\" (ie rust + some c), do w/e linking is needed for that, then distribute that with the roc source code. The roc cli will do this for you when developing but it doesn't work as nicely to compile just the platform with nix."}],["$","p",null,{"children":["For example, ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/roc-lang/roc/tree/main/examples/platform-switching/rust-platform","children":"this"}]," is one of the sample platforms"]}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"❯"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" exa"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":" --tree"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":" --level"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":" 2"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":"."}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" Cargo.lock"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" Cargo.toml"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" host.c"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" main.roc"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" rust-toolchain.toml"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"└──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" src"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"   ├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" glue.rs"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"   ├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" lib.rs"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"   └──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" main.rs"}]]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":["To build this platform you need to run a ",["$","code",null,{"children":"cargo build --lib ..."}]," on the rust code, compile the ",["$","code",null,{"children":"host.c"}]," file, link those two object files together, and then finally distribute the linked object file with the roc code."]}],["$","p",null,{"children":"so after all those steps, it should look something like"}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"❯"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" exa"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":" --tree"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" <"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"compiled"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" folde"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"r"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":">"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"<"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"compiled folder"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":">"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"├──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" linux-x64.o"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"└──"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" main.roc"}]]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":"The naive approach would probably be something like"}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"let"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"compiledC"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" mkDerivation"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # compile the c ..."}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"};"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"rustBuiltLib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" buildRustPackage"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # build the rust"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"};"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"in"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"llvmPkgs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"stdenv"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"mkDerivation"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" rec"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  name"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"pname"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"-"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"version"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  srcs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ["}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"    rustBuiltLib"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"    compiledC"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    ./."}],["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":" # for the roc code"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"  ];"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  sourceRoot"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \".\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  buildPhase"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ''"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    # link the rust and c files"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    # copy roc and linked object out"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"  ''"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"}"}]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":["while this works, it also sucks. ",["$","strong",null,{"children":"ANY"}]," change to the files will cause all 3 derivations to be rebuilt."]}],["$","p",null,{"children":"Now with filesets we can be all cute and fancy"}],["$","div",null,{"className":"grid place-content-center","children":["$","div",null,{"className":"rounded bg-gray-100 dark:bg-gray-800","children":["$","div",null,{"className":"box-content px-3 py-0","children":["$","p",null,{"children":["This example will have many parts omitted to keep the code easy to follow. To see the real code, look at my ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/JRMurr/roc2nix/blob/main/lib/platformBuilders/buildRustPlatform.nix","children":"roc2nix repo"}]," where this came from"]}]}]}]}],["$","p",null,{"children":"First let's define a helper file for filtering files based on their extension"}],["$","div",null,{"className":"remark-code-title","children":"languageFilters.nix"}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"{lib}:"}]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"# Note i generally don't like doing `with` at the top of a file"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"# but since this will be only fileSet stuff it should be fine"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"with"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" lib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileset"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"let"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # helper func to take in a list of allowed"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # returns a function of `file => bool` to be used in a fileFilter."}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # true if file has suffix, false if not"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    fileHasAnySuffix"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" fileSuffixes: file: ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"lib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"lists"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"any"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" (s: "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"lib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"hasSuffix"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" s"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" file"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"name"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":") "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileSuffixes"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":");"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # given a basePath src path, return a fileset of files in that path that are rust files, toml files, or cargo toml/lock"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    rustFilter"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" basePath: ("}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"        let"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"        mainFilter"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fileFilter"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"            ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileHasAnySuffix"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" [ "}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"\".rs\""}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \".toml\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ])"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"            basePath"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"        in"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"        unions"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" [ "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"mainFilter"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"basePath"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" +"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \"/Cargo.toml\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":") ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"basePath"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" +"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \"/Cargo.lock\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":") ]"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"    );"}]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # given a basePath src path return a fileset with files ending with `.c`"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    cFilter"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" basePath: "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileFilter"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileHasAnySuffix"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" [ "}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"\".c\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ]) "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"basePath"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"    # given a basePath src path return a fileset with files ending with `.roc`"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"    rocFilter"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" basePath: "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileFilter"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ("}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileHasAnySuffix"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" [ "}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"\".roc\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ]) "}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"basePath"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"in"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"{"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"  inherit"}],["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":" rustFilter"}],["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":" cFilter"}],["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":" rocFilter"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"}"}]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":"Now with that helper, we can do"}],["$","div",null,{"className":"remark-code-title","children":"buildRustPlatform.nix"}],["$","$L11",null,{"className":"shiki shiki-themes github-light github-dark","style":{"backgroundColor":"#fff","--shiki-dark-bg":"#24292e","color":"#24292e","--shiki-dark":"#e1e4e8"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"let"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" lib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"fileset"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  languageFilters"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF"},"children":" import"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./languageFilters.nix"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"inherit"}],["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":" lib"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";};"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  baseDir"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ./."}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  compiledC"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" mkDerivation"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"      src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"toSource"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"          root"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"          fileset"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" languageFilters"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"cFilter"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"      };"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"      # compile the c ..."}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"  };"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  rustBuiltLib"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" buildRustPackage"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"      src"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"toSource"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"        root"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"        fileset"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" languageFilters"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"rustFilter"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"      };"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#6a737d","--shiki-dark":"#6A737D"},"children":"      # build the rust"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"  };"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  rocCode"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" fs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"toSource"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"      root"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"      fileset"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" languageFilters"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"rocFilter"}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":" baseDir"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"  };"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"in"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"llvmPkgs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"stdenv"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":"."}],["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"mkDerivation"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" rec"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" {"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  name"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"pname"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"-"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"version"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  srcs"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":" ["}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"    rustBuiltLib"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"    compiledC"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#e36209","--shiki-dark":"#FFAB70"},"children":"    rocCode"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"  ];"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  sourceRoot"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" \".\""}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#6f42c1","--shiki-dark":"#B392F0"},"children":"  buildPhase"}],["$","span",null,{"style":{"color":"#d73a49","--shiki-dark":"#F97583"},"children":" ="}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" ''"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    # NOTE: this link could be pulled into its own derivation for even better seperation"}]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    # I only just realized this while making this post..."}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    $LD -r -L "}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"rustBuildName"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"/lib "}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"cBuildName"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"/"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"cHostDest"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" -lhost -o "}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"host_dest"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}]]}],"\n",["$","span",null,{"className":"line"}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    mkdir -p $out"}]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    cp "}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"host_dest"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":" $out/"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"host_dest"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"    cp -r "}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"$${"}],["$","span",null,{"style":{"color":"#005cc5","--shiki-dark":"#79B8FF","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"rocCode"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8","fontStyle":"italic","--shiki-dark-font-style":"italic"},"children":"}"}],["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"/. $out"}]]}],"\n",["$","span",null,{"className":"line","children":[["$","span",null,{"style":{"color":"#032f62","--shiki-dark":"#9ECBFF"},"children":"  ''"}],["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":";"}]]}],"\n",["$","span",null,{"className":"line","children":["$","span",null,{"style":{"color":"#24292e","--shiki-dark":"#E1E4E8"},"children":"}"}]}],"\n",["$","span",null,{"className":"line"}]]}]}],["$","p",null,{"children":"Now this is about as good as you can get. The rust and c builds have no dependency on each other so you are free to modify the c without needing to rebuild the rust."}],["$","p",null,{"children":"If you only change the roc code, you won't need to do any build (other than linking but in this example that could also be pulled out....)."}],["$","h2",null,{"id":"wrap-up","children":[["$","a",null,{"href":"#wrap-up","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"icon icon-link"}]}],"Wrap up"]}],["$","p",null,{"children":["Huge shoutout to ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/infinisil","children":"Silvan Mosberger"}]," from ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.tweag.io/","children":"Tweag"}]," for bringing file sets to the main Nix library. He was sponsored through my current employer ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://antithesis.com/","children":"Antithesis"}]," to develop this feature!"]}],["$","p",null,{"children":["I hope filesets make more people take a stab at making their own ",["$","code",null,{"children":"*2nix"}]," builders, or just make their own builds more efficent."]}],["$","p",null,{"children":["I had a lot of fun working on ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/JRMurr/roc2nix/","children":"roc2nix"}],", it was my first time making a \"real\" nix library and I learned a lot along the way (not just file sets). If you are interested in learning more about it check out the repo or let me know in the comments and I might make a separate blog diving into that (and hopefully some blogs on roc itself)."]}]]]}],["$","div",null,{"children":[["$","div",null,{"className":"pb-6 pt-6 text-sm text-gray-700 dark:text-gray-300","children":[["$","a",null,{"target":"_blank","rel":"nofollow","href":"https://mobile.twitter.com/search?q=https%3A%2F%2Fjohns.codes%2Fblog%2Fefficient-nix-derivations-with-file-sets","children":"Discuss on Twitter"}]," • ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/JRMurr/JRMurr.github.io/blob/main/content/blog/efficient-nix-derivations-with-file-sets.md","children":"View on GitHub"}]]}],["$","div",null,{"className":"pb-6 pt-6 text-center text-gray-700 dark:text-gray-300","id":"comment","children":["$","$L12",null,{}]}],"$undefined"]}]]}],["$","footer",null,{"children":["$","div",null,{"className":"flex flex-col text-sm font-medium sm:flex-row sm:justify-between sm:text-base","children":[["$","div",null,{"className":"pt-4 xl:pt-8","children":["$","$L9",null,{"href":"/blog/organizing-system-configs-with-nixos","className":"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","aria-label":"Previous post: Organizing system configs with NixOS","children":["← ","Organizing system configs with NixOS"]}]}],"$undefined"]}]}]]}]]}]}]]}]]
e:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Efficient Nix Derivations with File Sets | John's Codes"}],["$","meta","3",{"name":"description","content":"Using nix's new file set API to make efficient derivations"}],["$","meta","4",{"name":"robots","content":"index, follow"}],["$","meta","5",{"name":"googlebot","content":"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"}],["$","link","6",{"rel":"canonical","href":"https://johns.codes/blog/efficient-nix-derivations-with-file-sets"}],["$","link","7",{"rel":"alternate","type":"application/rss+xml","href":"https://johns.codes/feed.xml"}],["$","meta","8",{"property":"og:title","content":"Efficient Nix Derivations with File Sets"}],["$","meta","9",{"property":"og:description","content":"Using nix's new file set API to make efficient derivations"}],["$","meta","10",{"property":"og:url","content":"https://johns.codes/blog/efficient-nix-derivations-with-file-sets"}],["$","meta","11",{"property":"og:site_name","content":"John's Codes"}],["$","meta","12",{"property":"og:locale","content":"en_US"}],["$","meta","13",{"property":"og:type","content":"article"}],["$","meta","14",{"property":"article:published_time","content":"2023-12-02T21:22:44.113Z"}],["$","meta","15",{"property":"article:modified_time","content":"2023-12-02T21:22:44.113Z"}],["$","meta","16",{"property":"article:author","content":"John Murray"}],["$","meta","17",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","18",{"name":"twitter:title","content":"Efficient Nix Derivations with File Sets"}],["$","meta","19",{"name":"twitter:description","content":"Using nix's new file set API to make efficient derivations"}],["$","meta","20",{"name":"next-size-adjust"}]]
1:null
