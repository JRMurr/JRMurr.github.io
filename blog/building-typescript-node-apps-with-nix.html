<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Building Typescript Node Apps With Nix</title><meta name="robots" content="follow, index"/><meta name="description" content="Trying some different nix builders for typescript node apps"/><meta property="og:url" content="https://johns.codes/blog/building-typescript-node-apps-with-nix"/><meta property="og:type" content="article"/><meta property="og:site_name" content="John&#x27;s Codes"/><meta property="og:description" content="Trying some different nix builders for typescript node apps"/><meta property="og:title" content="Building Typescript Node Apps With Nix"/><meta property="og:image" content="https://johns.codes/static/images/twitter-card.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/JRMurrCodes"/><meta name="twitter:title" content="Building Typescript Node Apps With Nix"/><meta name="twitter:description" content="Trying some different nix builders for typescript node apps"/><meta name="twitter:image" content="https://johns.codes/static/images/twitter-card.png"/><meta property="article:published_time" content="2022-09-06T23:57:55.477Z"/><link rel="canonical" href="https://johns.codes/blog/building-typescript-node-apps-with-nix"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://johns.codes/blog/building-typescript-node-apps-with-nix"
  },
  "headline": "Building Typescript Node Apps With Nix",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://johns.codes/static/images/twitter-card.png"
    }
  ],
  "datePublished": "2022-09-06T23:57:55.477Z",
  "dateModified": "2022-09-06T23:57:55.477Z",
  "author": [
    {
      "@type": "Person",
      "name": "John Murray"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "John Murray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://johns.codes/static/images/logo.png"
    }
  },
  "description": "Trying some different nix builders for typescript node apps"
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/355c2a92f1ccaa5a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/355c2a92f1ccaa5a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-e558c14e4c6e2548.js" defer=""></script><script src="/_next/static/chunks/main-b77bb48dcc3828e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-888b7a5f22c99b4e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/675-374a5a75205d32da.js" defer=""></script><script src="/_next/static/chunks/545-f1dc6b53ce85b08b.js" defer=""></script><script src="/_next/static/chunks/460-923aca1e8d2d553b.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-5212da19635dab25.js" defer=""></script><script src="/_next/static/_5dYUg91qj2NP5UkDuoCq/_buildManifest.js" defer=""></script><script src="/_next/static/_5dYUg91qj2NP5UkDuoCq/_ssgManifest.js" defer=""></script><script src="/_next/static/_5dYUg91qj2NP5UkDuoCq/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="John&#x27;s Codes" href="/"><div class="flex items-center justify-between"><div class="hidden h-6 text-2xl font-semibold sm:block">John&#x27;s Codes</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/projects">Projects</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="w-8 h-8 p-1 ml-1 mr-1 rounded sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed flex-col hidden gap-3 right-8 bottom-8 md:hidden"><button aria-label="Scroll To Comment" type="button" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-4 md:space-y-2 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="flex justify-center items-center text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-09-06T23:57:55.477Z">Tuesday, September 6, 2022</time><span class="mx-2">-</span><div class="flex items-center"><span class="ml-1">13 min read</span></div></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Building Typescript Node Apps With Nix</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-4 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><details open=""><summary class="pt-2 pb-2 ml-6 text-xl font-bold">Table of Contents</summary><div class="ml-6"><ul><li class="false"><a href="#being-a-nix-stan">Being a Nix Stan</a></li><li class="false"><a href="#the-app">The APP</a></li><li class="false"><a href="#nix-builds">Nix Builds</a></li><li class="ml-6"><a href="#the-standard-environment">The Standard Environment</a></li><li class="ml-6"><a href="#node2nix">node2nix</a></li><li class="ml-6"><a href="#dream2nix">dream2nix</a></li><li class="false"><a href="#conclusion">Conclusion</a></li></ul></div></details>
<h2 id="being-a-nix-stan"><a href="#being-a-nix-stan" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Being a Nix Stan</h2>
<p>I recently accepted that I am obsessed with nix. Ask anyone with a remotely technical person with a pulse, and they can probably mention at least 10 times I&#x27;ve told them &quot;but with nix X is way easier/a non issue&quot; (same with rust, but that&#x27;s for another day...).</p>
<p>The issue is, I&#x27;m a bit of a poser. I&#x27;ve been using Nix on/off for about 2.5 years but only seriously for the last 10ish months.
I&#x27;ve mostly just consumed existing NixOS modules, nix packages, setup basic nix-shells/flakes, and relatively simple nix builders. All of these uses of nix where pretty great, and it definitely made my life easier, but it only went so far to solve some of the challenges I come across in my personal projects/work.</p>
<p>During my initial nix learning phase I came across <code>node2nix</code> but the codegen step made me think that node and nix just don&#x27;t get along well, and I never looked further.
My job primarily involves node web servers written in typescript. All I&#x27;ve done with nix so far at work is set up basic dev environments with node. While it did make our README(s) a little nicer, it does not really solve our issues in actually deploying our apps.
Now that I got over the initial hump of adding nix to some of our processes, it&#x27;s time to make it even better!</p>
<p>If you are not familiar with nix, <a href="/blog/rust-enviorment-and-docker-build-with-nix-flakes">this post</a> goes over the basics of nix and builds a basic rust app.</p>
<h2 id="the-app"><a href="#the-app" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The APP</h2>
<p>The source code for the app is <a target="_blank" rel="noopener noreferrer" href="https://github.com/JRMurr/example-ts-node-nix">here</a></p>
<p>First I need a basic app to build. I have been using <a target="_blank" rel="noopener noreferrer" href="https://www.fastify.io/">Fastify</a> recently, so I will attempt to build this basic web server.</p>
<div class="remark-code-title">index.ts</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#6272A4">#!/usr/bin/env node</span></div><div class="line"></div><div class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> fastify </span><span style="color:#FF79C6">from</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fastify</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> server </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">fastify</span><span style="color:#F8F8F2">();</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">server.</span><span style="color:#50FA7B">get</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">/ping</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">async</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">_request</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C">_reply</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">return</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">pong</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">});</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">server.</span><span style="color:#50FA7B">listen</span><span style="color:#F8F8F2">({ host</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">0.0.0.0</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, port</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">8080</span><span style="color:#F8F8F2"> }, (</span><span style="color:#FFB86C">err</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C">address</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (err) {</span></div><div class="line"><span style="color:#F8F8F2">    console.</span><span style="color:#50FA7B">error</span><span style="color:#F8F8F2">(err);</span></div><div class="line"><span style="color:#F8F8F2">    process.</span><span style="color:#50FA7B">exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span></div><div class="line"><span style="color:#F8F8F2">  }</span></div><div class="line"><span style="color:#F8F8F2">  console.</span><span style="color:#50FA7B">log</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">`Server listening at </span><span style="color:#FF79C6">${</span><span style="color:#F8F8F2">address</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">`</span><span style="color:#F8F8F2">);</span></div><div class="line"><span style="color:#F8F8F2">});</span></div></code></div></pre></div>
<p>One important note about the <code>index.ts</code> file is the node shebang at the top. This will allow this file to act as a binary/entry point for the server.</p>
<p>I also added a strict tsconfig that outputs to <code>./dist</code> and a package.json that looks like</p>
<div class="remark-code-title">package.json</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">json</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">name</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">example-node-nix</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">version</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">1.0.0</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">main</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">dist/index.js</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">bin</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">example-node-nix</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">dist/index.js</span><span style="color:#E9F284">&quot;</span></div><div class="line"><span style="color:#F8F8F2">  },</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">scripts</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">build</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">tsc -p tsconfig.json</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">start</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">node dist/index.js</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">  },</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">license</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">MIT</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">dependencies</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">fastify</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">^4.5.3</span><span style="color:#E9F284">&quot;</span></div><div class="line"><span style="color:#F8F8F2">  },</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">devDependencies</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">@tsconfig/node16</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">^1.0.1</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">@tsconfig/node16-strictest</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">^1.0.0</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">@types/node</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">^18.7.14</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#8BE9FE">&quot;</span><span style="color:#8BE9FD">typescript</span><span style="color:#8BE9FE">&quot;</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">^4.8.2</span><span style="color:#E9F284">&quot;</span></div><div class="line"><span style="color:#F8F8F2">  }</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>I made a simple <code>flake.nix</code> to set up node then ran</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">sh</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">$ npm run build</span></div><div class="line"><span style="color:#F8F8F2">$ npm run start</span></div></code></div></pre></div>
<p>The sever is up and is responding.</p>
<h2 id="nix-builds"><a href="#nix-builds" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Nix Builds</h2>
<p>Like usual with nix I first try to see if other people have figured this out already, looking at the <a target="_blank" rel="noopener noreferrer" href="https://nixos.org/manual/nixpkgs/stable/#language-javascript">nixpkgs JS docs</a>, it mentions a few builders like <code>mkYarnPackage</code>, <a target="_blank" rel="noopener noreferrer" href="https://github.com/svanderburg/node2nix">node2nix</a>, <a target="_blank" rel="noopener noreferrer" href="https://github.com/nix-community/npmlock2nix">npmlock2nix</a>, and <a target="_blank" rel="noopener noreferrer" href="https://github.com/serokell/nix-npm-buildpackage">nix-npm-buildpackage</a>. These all seemed fine but I couldnt find any good typescript example, or the docs were a little lacking to get started. So I figured why not just do it the dumb way to start and do it manually, what&#x27;s the worst that can happen?</p>
<h3 id="the-standard-environment"><a href="#the-standard-environment" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The Standard Environment</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://nixos.org/manual/nixpkgs/stable/#sec-using-stdenv">stdenv.mkDerivation</a> is what most &quot;high level&quot; builders wrap. It provides you a sandbox environment with some common programs like <code>coreutils</code>, <code>grep</code>, <code>awk</code>, <code>make</code>, etc., to build a program. It is very versatile and surprisingly easy to use once you get comfortable with its ideas. I was hopeful I could throw something together, so to start I just focused on the <code>buildPhase</code> and a very basic <code>installPhase</code> to verify everything was built, I would deal with running it later.</p>
<div class="remark-code-title">flake.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">description</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;Sample Nix ts-node build&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">flake-utils</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:numtide/flake-utils&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">gitignore</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:hercules-ci/gitignore.nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">follows</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;nixpkgs&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">outputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { </span><span style="color:#FFB86C">self</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">... </span><span style="color:#F8F8F2">}:</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">eachDefaultSystem</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">system</span><span style="color:#F8F8F2">:</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">pkgs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD">import</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">system</span><span style="color:#F8F8F2">; };</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">nodejs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">nodejs-16_x</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#6272A4"># NOTE: this does not work</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">appBuild</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;example-ts-node&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">version</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;0.1.0&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">gitignoreSource</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">; </span><span style="color:#6272A4"># uses the gitignore in the repo to only copy files git would see</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">buildInputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">nodejs</span><span style="color:#F8F8F2"> ];</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#6272A4"># https://nixos.org/manual/nixpkgs/stable/#sec-stdenv-phases</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">            # each phase has pre/postHooks. When you make your own phase be sure to still call the hooks</span></div><div class="line"><span style="color:#F1FA8C">            runHook preBuild</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            npm ci</span></div><div class="line"><span style="color:#F1FA8C">            npm run build</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            runHook postBuild</span></div><div class="line"><span style="color:#F1FA8C">          &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">installPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">            runHook preInstall</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            cp -r node_modules $out/node_modules</span></div><div class="line"><span style="color:#F1FA8C">            cp package.json $out/package.json</span></div><div class="line"><span style="color:#F1FA8C">            cp -r dist $out/dist</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            runHook postInstall</span></div><div class="line"><span style="color:#F1FA8C">          &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">with</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#F8F8F2">; {</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">defaultPackage</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">appBuild</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">devShell</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">mkShell</span><span style="color:#F8F8F2"> { </span><span style="color:#50FA7B">buildInputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">nodejs</span><span style="color:#F8F8F2"> ]; };</span></div><div class="line"><span style="color:#F8F8F2">      });</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>I tried <code>nix build</code> but I got this error</p>
<div class="relative"><pre class="shiki dracula"><div class="code-container"><code><div class="line"><span style="color:undefined">error: builder for &#x27;/nix/store/7lis43p7zj10y2cf6inzicjdgzc3b5qs-example-ts-node.drv&#x27; failed with exit code 1;
       last 10 log lines:
       &gt; no configure script, doing nothing
       &gt; building
       &gt; npm ERR! code EAI_AGAINler: sill audit bulk request {[0m
       &gt; npm ERR! syscall getaddrinfo
       &gt; npm ERR! errno EAI_AGAIN
       &gt; npm ERR! request to https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz failed, reason: getaddrinfo EAI_AGAIN registry.npmjs.org
       &gt;
       &gt; npm ERR! Log files were not written due to an error writing to the directory: /homeless-shelter/.npm/_logs
       &gt; npm ERR! You can rerun the command with `--loglevel=verbose` to see the logs in your terminal
       &gt;
       For full logs, run &#x27;nix log /nix/store/7lis43p7zj10y2cf6inzicjdgzc3b5qs-example-ts-node.drv&#x27;.</span></div></code></div></pre></div>
<p>The error <code>getaddrinfo EAI_AGAIN registry.npmjs.org</code> is a failure to connect to the NPM registry to install the dependencies. What I failed to realize is that the nix sandbox would block outside requests in the builder since they are not fully reproducible. You can disable the nix sandbox, but that would be gross. So time to try one of these builders.</p>
<h3 id="node2nix"><a href="#node2nix" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>node2nix</h3>
<p>Of all the builders I&#x27;ve seen so far <a target="_blank" rel="noopener noreferrer" href="https://github.com/svanderburg/node2nix">node2nix</a> seemed like the most mature. It&#x27;s actually used in the <a target="_blank" rel="noopener noreferrer" href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/node-packages">official nixpkgs repo</a>. At a high level <code>node2nix</code> will parse your <code>package.json</code> or <code>package-lock.json</code> and do code-gen to give you nix files that use <a target="_blank" rel="noopener noreferrer" href="https://ryantm.github.io/nixpkgs/builders/fetchers/">fetchers</a> to download all <code>node_modules</code> and build your node app.</p>
<p>You can install <code>node2nix</code> from <code>nixpkgs</code> as <code>pkgs.node2nix</code>. To run it I have this script</p>
<div class="remark-code-title">runNode2Nix.sh</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">sh</div><div class="code-container"><code><div class="line"><span style="color:#6272A4">#!/usr/bin/env bash</span></div><div class="line"></div><div class="line"><span style="color:#6272A4"># You need to re-run this file anytime your package/package-lock.json changes</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">node2nix -16 --development \</span></div><div class="line"><span style="color:#F8F8F2">    --input package.json \</span></div><div class="line"><span style="color:#F8F8F2">    --lock package-lock.json \</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># Put all generated code in the `./nix` directory</span></div><div class="line"><span style="color:#F8F8F2">    --node-env ./nix/node-env.nix \</span></div><div class="line"><span style="color:#F8F8F2">    --composition ./nix/default.nix \</span></div><div class="line"><span style="color:#F8F8F2">    --output ./nix/node-package.nix</span></div></code></div></pre></div>
<p>While node2nix does have helpers in <code>node-env.nix</code> to build a node package, those only really run <code>npm install</code>, to call our <code>npm run build</code> step. Thankfully as described <a target="_blank" rel="noopener noreferrer" href="https://github.com/svanderburg/node2nix#using-the-nodejs-environment-in-other-nix-derivations">here</a> <code>node2nix</code> exposes an output of just the <code>node_modules</code> of the dependencies, allowing us to make our own derivation.</p>
<div class="remark-code-title">flake.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">description</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;Sample Nix ts-node build&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">flake-utils</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:numtide/flake-utils&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">gitignore</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:hercules-ci/gitignore.nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">follows</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;nixpkgs&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">outputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { </span><span style="color:#FFB86C">self</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">... </span><span style="color:#F8F8F2">}:</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">eachDefaultSystem</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">system</span><span style="color:#F8F8F2">:</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">pkgs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD">import</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">system</span><span style="color:#F8F8F2">; };</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">nodejs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">nodejs-16_x</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">node2nixOutput</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD">import</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./nix</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">pkgs</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">nodejs</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">system</span><span style="color:#F8F8F2">; };</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#6272A4"># NOTE: may want to try https://github.com/svanderburg/node2nix/issues/301 to limit rebuilds</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">nodeDeps</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">node2nixOutput</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">nodeDependencies</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">app</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">stdenv</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">mkDerivation</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;example-ts-node&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">version</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;0.1.0&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">src</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">gitignoreSource</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">buildInputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">nodejs</span><span style="color:#F8F8F2"> ];</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">buildPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">            runHook preBuild</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            # symlink the generated node deps to the current directory for building</span></div><div class="line"><span style="color:#F1FA8C">            ln -sf </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">nodeDeps</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/lib/node_modules ./node_modules</span></div><div class="line"><span style="color:#F1FA8C">            export PATH=&quot;</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">nodeDeps</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/bin:$PATH&quot;</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            npm run build</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            runHook postBuild</span></div><div class="line"><span style="color:#F1FA8C">          &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">installPhase</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&#x27;&#x27;</span></div><div class="line"><span style="color:#F1FA8C">            runHook preInstall</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            # Note: you need some sort of `mkdir` on $out for any of the following commands to work</span></div><div class="line"><span style="color:#F1FA8C">            mkdir -p $out/bin</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            # copy only whats needed for running the built app</span></div><div class="line"><span style="color:#F1FA8C">            cp package.json $out/package.json</span></div><div class="line"><span style="color:#F1FA8C">            cp -r dist $out/dist</span></div><div class="line"><span style="color:#F1FA8C">            ln -sf </span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">nodeDeps</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">/lib/node_modules $out/node_modules</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            # copy entry point, in this case our index.ts has the node shebang</span></div><div class="line"><span style="color:#F1FA8C">            # nix will patch the shebang to be the node version specified in buildInputs</span></div><div class="line"><span style="color:#F1FA8C">            # you could also copy in a script that is basically `npm run start`</span></div><div class="line"><span style="color:#F1FA8C">            cp dist/index.js $out/bin/example-ts-nix</span></div><div class="line"><span style="color:#F1FA8C">            chmod a+x $out/bin/example-ts-nix</span></div><div class="line"></div><div class="line"><span style="color:#F1FA8C">            runHook postInstall</span></div><div class="line"><span style="color:#F1FA8C">          &#x27;&#x27;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        };</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">with</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#F8F8F2">; {</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">defaultPackage</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">app</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">devShell</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">mkShell</span><span style="color:#F8F8F2"> { </span><span style="color:#50FA7B">buildInputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">nodejs</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">node2nix</span><span style="color:#F8F8F2"> ]; };</span></div><div class="line"><span style="color:#F8F8F2">      });</span></div><div class="line"><span style="color:#F8F8F2">}</span></div><div class="line"></div></code></div></pre></div>
<p>After running <code>nix build</code>, the output will be symlinked to <code>./result</code> in my case it looks like</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">sh</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">$ exa --tree --level 3 ./result/</span></div><div class="line"><span style="color:#F8F8F2">./result</span></div><div class="line"><span style="color:#F8F8F2">├── bin</span></div><div class="line"><span style="color:#F8F8F2">│  └── example-ts-nix</span></div><div class="line"><span style="color:#F8F8F2">├── dist</span></div><div class="line"><span style="color:#F8F8F2">│  └── index.js</span></div><div class="line"><span style="color:#F8F8F2">├── node_modules -</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> /nix/store/fdzk00z6bmw50mfqv124lgn9fzjhd7yw-node-dependencies-example-node-nix-1.0.0/lib/node_modules</span></div><div class="line"><span style="color:#F8F8F2">└── package.json</span></div></code></div></pre></div>
<p>To verify the app worked you can run <code>./result/bin/example-ts-nix</code>.</p>
<p>While at first this looks like a lot It&#x27;s pretty straightforward. <code>node2nixOutput = import ./nix { inherit pkgs nodejs system; };</code> calls the generated <code>default.nix</code> which exposes many outputs for building. In our case we only use <code>nodeDeps = node2nixOutput.nodeDependencies;</code>.</p>
<p>The <code>buildPhase</code> just symlinks the generated <code>nodeDependencies</code> and builds the app. The <code>installPhase</code> copies the built output into the final derivation. If your familiar with docker files this is sorta like having a build layer than a final layer to copy the outputs to.
One thing nix does for you is patch shebangs to reference the <code>buildInputs</code> of the derivation, in this case if you run</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">sh</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">$ cat ./result/bin/example-ts-nix</span></div><div class="line"><span style="color:#6272A4">#!/nix/store/6cdccplrjwga5rd3b2s7xb8zd25hnsix-nodejs-16.17.0/bin/node</span></div><div class="line"><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">use strict</span><span style="color:#E9F284">&quot;</span><span style="color:#FF79C6">;</span></div><div class="line"><span style="color:#F8F8F2">...</span></div></code></div></pre></div>
<p>It changed <code>#!/usr/bin/env node</code> to <code>#!/nix/store/6cdccplrjwga5rd3b2s7xb8zd25hnsix-nodejs-16.17.0/bin/node</code> for us automatically.</p>
<p><strong>node2nix Pros</strong></p>
<ul>
<li>Simple to follow build process</li>
<li>Somewhat easy to customize</li>
<li>Has support for custom registries/private git repos</li>
</ul>
<p><strong>node2nix Cons</strong></p>
<ul>
<li>Having to re-run <code>node2nix</code> on package.json changes is annoying</li>
<li>The generated outputs seem to re-build too often, see <a target="_blank" rel="noopener noreferrer" href="https://github.com/svanderburg/node2nix/issues/301">here</a></li>
<li>With the current setup the final build is still using the development <code>node_modules</code> which is wasteful</li>
</ul>
<p>Overall I think <code>node2nix</code> is a good start for most node apps. Since its all mostly code-gen It&#x27;s easy to follow what&#x27;s going on. I&#x27;ve come across <a target="_blank" rel="noopener noreferrer" href="https://github.com/MatrixAI/TypeScript-Demo-Lib-Native">this template</a> which seems to have figured out to work around some cons listed, but I have not tried it yet so your mileage may vary.</p>
<h3 id="dream2nix"><a href="#dream2nix" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>dream2nix</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/nix-community/dream2nix">dream2nix</a> says its &quot;A framework for automated nix packaging&quot; by mostly standardizing the many &quot;2nix&quot; tools. The <a target="_blank" rel="noopener noreferrer" href="https://nix-community.github.io/dream2nix/">docs</a> list Rust, Haskell, Python, and Node builders.
For whatever reason I have been skeptical of dream2nix. It looked &quot;too good to be true&quot; so I never really gave it a fair shake. Better late than never, let&#x27;s try it</p>
<div class="remark-code-title">flake.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">description</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;Sample Nix ts-node build&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">flake-utils</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:numtide/flake-utils&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">gitignore</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:hercules-ci/gitignore.nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">follows</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;nixpkgs&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">dream2nix</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nix-community/dream2nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">outputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { </span><span style="color:#FFB86C">self</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dream2nix</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">... </span><span style="color:#F8F8F2">}:</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4"># Note: no need for flake-utils.lib.eachDefaultSystem, dream2nix does it for us</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FFB86C">dream2nix</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">makeFlakeOutputs</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">systems</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">defaultSystems</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">config</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">projectRoot</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">source</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">gitignoreSource</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>The core idea of dream2nix is that it will find you package.json/package-lock.json to figure out what node deps you need and how to build <code>npm run build</code> or w/e else. You can customize it but for most apps this should &quot;just work&quot;.</p>
<p>Running <code>nix flake show</code> returns</p>
<div class="relative"><pre class="shiki dracula"><div class="code-container"><code><div class="line"><span style="color:undefined">git+file:///home/jr/code/node/example-node-nix
├───devShell
│   ├───aarch64-darwin: development environment &#x27;nix-shell&#x27;
│   ├───aarch64-linux: development environment &#x27;nix-shell&#x27;
│   ├───i686-linux: development environment &#x27;nix-shell&#x27;
│   ├───x86_64-darwin: development environment &#x27;nix-shell&#x27;
│   └───x86_64-linux: development environment &#x27;nix-shell&#x27;
├───devShells
│   ├───aarch64-darwin
│   │   ├───default: development environment &#x27;nix-shell&#x27;
│   │   └───example-node-nix: development environment &#x27;nix-shell&#x27;
│   ├───aarch64-linux
│   │   ├───default: development environment &#x27;nix-shell&#x27;
│   │   └───example-node-nix: development environment &#x27;nix-shell&#x27;
│   ├───i686-linux
│   │   ├───default: development environment &#x27;nix-shell&#x27;
│   │   └───example-node-nix: development environment &#x27;nix-shell&#x27;
│   ├───x86_64-darwin
│   │   ├───default: development environment &#x27;nix-shell&#x27;
│   │   └───example-node-nix: development environment &#x27;nix-shell&#x27;
│   └───x86_64-linux
│       ├───default: development environment &#x27;nix-shell&#x27;
│       └───example-node-nix: development environment &#x27;nix-shell&#x27;
├───packages
│   ├───aarch64-darwin
│   │   ├───default: package &#x27;example-node-nix-1.0.0&#x27;
│   │   ├───example-node-nix: package &#x27;example-node-nix-1.0.0&#x27;
│   │   └───resolveImpure: package &#x27;resolve&#x27;
│   ├───aarch64-linux
│   │   ├───default: package &#x27;example-node-nix-1.0.0&#x27;
│   │   ├───example-node-nix: package &#x27;example-node-nix-1.0.0&#x27;
│   │   └───resolveImpure: package &#x27;resolve&#x27;
│   ├───i686-linux
│   │   ├───default: package &#x27;example-node-nix-1.0.0&#x27;
│   │   ├───example-node-nix: package &#x27;example-node-nix-1.0.0&#x27;
│   │   └───resolveImpure: package &#x27;resolve&#x27;
│   ├───x86_64-darwin
│   │   ├───default: package &#x27;example-node-nix-1.0.0&#x27;
│   │   ├───example-node-nix: package &#x27;example-node-nix-1.0.0&#x27;
│   │   └───resolveImpure: package &#x27;resolve&#x27;
│   └───x86_64-linux
│       ├───default: package &#x27;example-node-nix-1.0.0&#x27;
│       ├───example-node-nix: package &#x27;example-node-nix-1.0.0&#x27;
│       └───resolveImpure: package &#x27;resolve&#x27;
└───projectsJson: unknown</span></div></code></div></pre></div>
<p>dream2nix gave us a dev shell and package build for us, neat. Expecting something to break I ran <code>nix build</code> to build the app and got no errors. Looking at <code>./result</code> gives</p>
<div class="relative"><pre class="shiki dracula"><div class="language-id">sh</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">$ exa --tree --level 3 ./result/</span></div><div class="line"><span style="color:#F8F8F2">./result</span></div><div class="line"><span style="color:#F8F8F2">├── bin</span></div><div class="line"><span style="color:#F8F8F2">│  └── ts-node-nix -</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> ../lib/node_modules/example-node-nix/dist/index.js</span></div><div class="line"><span style="color:#F8F8F2">└── lib</span></div><div class="line"><span style="color:#F8F8F2">   └── node_modules</span></div><div class="line"><span style="color:#F8F8F2">      └── example-node-nix</span></div></code></div></pre></div>
<p><code>ts-node-nix</code> is a compiled javascript file with the right shebang. Still somewhat shocked running <code>./result/bin/ts-node-nix</code> ran the server, and it worked!</p>
<p>This is simply wild, I really expected something to break here and require a manual build step of some kind. One nice thing to note is the <a target="_blank" rel="noopener noreferrer" href="https://nix-community.github.io/dream2nix/guides/getting-started-nodejs.html#development-shell">node dev shell</a> it gives will copy over the <code>node_modules</code> folder for you so you don&#x27;t need to manually run <code>npm install</code>.</p>
<p>To limit my excitement a bit this is a simple build. I need to investigate how well it works with more complicated builds with native node add-ons, mono repo tools like NX, etc. Though the examples in the <a target="_blank" rel="noopener noreferrer" href="https://github.com/nix-community/dream2nix#test-the-experimental-version-of-dream2nix">README</a> seem promising to allow for easily overriding the builds.</p>
<p><strong>dream2nix Pros</strong></p>
<ul>
<li>very little code to set up</li>
<li>generated dev shell is really nice</li>
</ul>
<p><strong>dream2nix Cons</strong></p>
<ul>
<li>A bit of a &quot;black box&quot; which could make debugging harder</li>
<li>It seems to include the full development dependencies in the output</li>
</ul>
<h2 id="conclusion"><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2>
<p>I came into this thinking building ts node apps with nix would be a pain, and I&#x27;m happily surprised it is not. While <code>node2nix</code> may be good for highly customizable builds, <code>dream2nix</code> is just a delight. I haven&#x27;t come across a nix utility that just worked like that with minimal messing around.</p>
<p>I&#x27;ve been meaning to give <a target="_blank" rel="noopener noreferrer" href="https://napi.rs/">napi-rs</a> a shot, so maybe that will be a good test case to see how well <code>dream2nix</code> builds rust projects and native node add-ons all in one.</p>
<p>Since you made it to the end here&#x27;s a <code>dream2nix</code> example with a docker build</p>
<div class="remark-code-title">flake.nix</div>
<div class="relative"><pre class="shiki dracula"><div class="language-id">nix</div><div class="code-container"><code><div class="line"><span style="color:#F8F8F2">{</span></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">description</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;Sample Nix ts-node build&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">flake-utils</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:numtide/flake-utils&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">gitignore</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:hercules-ci/gitignore.nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">inputs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">nixpkgs</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">follows</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;nixpkgs&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">    };</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#50FA7B">dream2nix</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">url</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;github:nix-community/dream2nix&quot;</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">  };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">outputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { </span><span style="color:#FFB86C">self</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dream2nix</span><span style="color:#FF79C6">,</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">... </span><span style="color:#F8F8F2">}:</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">dream2nixOutputs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dream2nix</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">makeFlakeOutputs</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">systems</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">defaultSystems</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">config</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">projectRoot</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#50FA7B">source</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">gitignore</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">gitignoreSource</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">./.</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">      };</span></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#50FA7B">customOutput</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">flake-utils</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">eachDefaultSystem</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C">system</span><span style="color:#F8F8F2">:</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">let</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">pkgs</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD">import</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">inherit</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">system</span><span style="color:#F8F8F2">; };</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#6272A4"># the dream2nix output for this system</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">app</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dream2nixOutputs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">packages</span><span style="color:#FF79C6">.</span><span style="color:#F1FA8C">&quot;</span><span style="color:#FF79C6">${</span><span style="color:#FFB86C">system</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">&quot;</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">example-node-nix</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">with</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#F8F8F2">; {</span></div><div class="line"><span style="color:#F8F8F2">          </span><span style="color:#50FA7B">packages</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">docker</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dockerTools</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">buildImage</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">app</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">packageName</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#50FA7B">copyToRoot</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">pkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">buildEnv</span><span style="color:#F8F8F2"> {</span></div><div class="line"><span style="color:#F8F8F2">              </span><span style="color:#50FA7B">name</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">app</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">packageName</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">              </span><span style="color:#50FA7B">paths</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#FFB86C">app</span><span style="color:#F8F8F2"> ];</span></div><div class="line"><span style="color:#F8F8F2">              </span><span style="color:#50FA7B">pathsToLink</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">&quot;/bin&quot;</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">&quot;/lib&quot;</span><span style="color:#F8F8F2"> ];</span></div><div class="line"><span style="color:#F8F8F2">            };</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#6272A4"># This ensures symlinks to directories are preserved in the image</span></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#50FA7B">keepContentsDirlinks</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">            </span><span style="color:#50FA7B">config</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { </span><span style="color:#50FA7B">Cmd</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [ </span><span style="color:#F1FA8C">&quot;/bin/ts-node-nix&quot;</span><span style="color:#F8F8F2"> ]; };</span></div><div class="line"><span style="color:#F8F8F2">          };</span></div><div class="line"><span style="color:#F8F8F2">        });</span></div><div class="line"></div><div class="line"><span style="color:#F8F8F2">      </span><span style="color:#6272A4"># deep merge outputs together</span></div><div class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">nixpkgs</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">lib</span><span style="color:#FF79C6">.</span><span style="color:#FFB86C">recursiveUpdate</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">dream2nixOutputs</span><span style="color:#F8F8F2"> </span><span style="color:#FFB86C">customOutput</span><span style="color:#F8F8F2">;</span></div><div class="line"><span style="color:#F8F8F2">}</span></div></code></div></pre></div>
<p>You can then run <code>nix build .#docker</code> and then run <code>docker load &lt; result</code> to load the image into docker. See <a href="/blog/rust-enviorment-and-docker-build-with-nix-flakes">here</a> for some more info on nix docker builds.</p></div></div></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/JRMurr"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/JRMurrCodes"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="/feed.xml"><span class="sr-only">rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.912 24.912" style="enable-background:new 0 0 24.912 24.912" xml:space="preserve" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M3.692 17.517A3.696 3.696 0 0 0 0 21.211C0 23.244 1.656 24.9 3.692 24.9s3.694-1.657 3.694-3.689a3.697 3.697 0 0 0-3.694-3.694z"></path><path d="M.384 8.142A.386.386 0 0 0 0 8.527v4.688c0 .211.173.383.384.383 6.02 0 10.919 4.898 10.919 10.92 0 .209.171.383.384.383h4.705a.385.385 0 0 0 .387-.383l-.018-.121C16.692 15.423 9.37 8.142.384 8.142z"></path><path d="M24.89 24.397C24.825 10.936 13.854.011.384.011A.385.385 0 0 0 0 .397v4.824c0 .212.173.383.384.383 10.429 0 18.913 8.486 18.913 18.914 0 .209.172.383.382.383h4.845a.39.39 0 0 0 .388-.383l-.022-.121z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>John Murray</div><div> • </div><div>© 2022</div><div> • </div><a href="/">John&#x27;s Codes</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var c=Object.defineProperty;var t=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,y=Object.prototype.hasOwnProperty;var i=n=\u003ec(n,\"__esModule\",{value:!0});var m=(n,s)=\u003e()=\u003e(s||n((s={exports:{}}).exports,s),s.exports),u=(n,s)=\u003e{i(n);for(var r in s)c(n,r,{get:s[r],enumerable:!0})},v=(n,s,r)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let e of h(s))!y.call(n,e)\u0026\u0026e!==\"default\"\u0026\u0026c(n,e,{get:()=\u003es[e],enumerable:!(r=t(s,e))||r.enumerable});return n},C=n=\u003ev(i(c(n!=null?d(p(n)):{},\"default\",n\u0026\u0026n.__esModule\u0026\u0026\"default\"in n?{get:()=\u003en.default,enumerable:!0}:{value:n,enumerable:!0})),n);var a=m((b,F)=\u003e{F.exports=_jsx_runtime});var k={};u(k,{default:()=\u003eN,frontmatter:()=\u003eg});var l=C(a()),g={title:\"Building Typescript Node Apps With Nix\",date:new Date(1662508675477),tags:[\"nix\",\"typescript\",\"node\"],draft:!1,summary:\"Trying some different nix builders for typescript node apps\",images:[],layout:\"PostLayout\"};function x(n={}){let{wrapper:s}=n.components||{};return s?(0,l.jsx)(s,Object.assign({},n,{children:(0,l.jsx)(r,{})})):r();function r(){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",code:\"code\",pre:\"pre\",div:\"div\",h3:\"h3\",strong:\"strong\",ul:\"ul\",li:\"li\"},n.components),{TOCInline:o}=e;return o||B(\"TOCInline\",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o,{toc:n.toc,asDisclosure:!0}),`\n`,(0,l.jsxs)(e.h2,{id:\"being-a-nix-stan\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#being-a-nix-stan\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"Being a Nix Stan\"]}),`\n`,(0,l.jsx)(e.p,{children:`I recently accepted that I am obsessed with nix. Ask anyone with a remotely technical person with a pulse, and they can probably mention at least 10 times I've told them \"but with nix X is way easier/a non issue\" (same with rust, but that's for another day...).`}),`\n`,(0,l.jsx)(e.p,{children:`The issue is, I'm a bit of a poser. I've been using Nix on/off for about 2.5 years but only seriously for the last 10ish months.\nI've mostly just consumed existing NixOS modules, nix packages, setup basic nix-shells/flakes, and relatively simple nix builders. All of these uses of nix where pretty great, and it definitely made my life easier, but it only went so far to solve some of the challenges I come across in my personal projects/work.`}),`\n`,(0,l.jsxs)(e.p,{children:[\"During my initial nix learning phase I came across \",(0,l.jsx)(e.code,{children:\"node2nix\"}),` but the codegen step made me think that node and nix just don't get along well, and I never looked further.\nMy job primarily involves node web servers written in typescript. All I've done with nix so far at work is set up basic dev environments with node. While it did make our README(s) a little nicer, it does not really solve our issues in actually deploying our apps.\nNow that I got over the initial hump of adding nix to some of our processes, it's time to make it even better!`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"If you are not familiar with nix, \",(0,l.jsx)(e.a,{href:\"/blog/rust-enviorment-and-docker-build-with-nix-flakes\",children:\"this post\"}),\" goes over the basics of nix and builds a basic rust app.\"]}),`\n`,(0,l.jsxs)(e.h2,{id:\"the-app\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#the-app\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"The APP\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The source code for the app is \",(0,l.jsx)(e.a,{href:\"https://github.com/JRMurr/example-ts-node-nix\",children:\"here\"})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"First I need a basic app to build. I have been using \",(0,l.jsx)(e.a,{href:\"https://www.fastify.io/\",children:\"Fastify\"}),\" recently, so I will attempt to build this basic web server.\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"index.ts\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"ts\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"#!/usr/bin/env node\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" fastify \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"from\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"fastify\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"const\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" server \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"fastify\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"();\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"server.\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"get\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"(\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/ping\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\", \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"async\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"_request\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\", \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"_reply\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\u003e\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"return\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"pong\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\\\\n\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"});\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"server.\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"listen\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"({ host\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"0.0.0.0\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\", port\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#BD93F9\"},children:\"8080\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" }, (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"err\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\", \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"address\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\") \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\u003e\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"if\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (err) {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    console.\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"error\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"(err);\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    process.\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"exit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"(\"}),(0,l.jsx)(e.span,{style:{color:\"#BD93F9\"},children:\"1\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\");\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  }\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  console.\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"log\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"(\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"`Server listening at \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"address\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"`\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\");\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"});\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"One important note about the \",(0,l.jsx)(e.code,{children:\"index.ts\"}),\" file is the node shebang at the top. This will allow this file to act as a binary/entry point for the server.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I also added a strict tsconfig that outputs to \",(0,l.jsx)(e.code,{children:\"./dist\"}),\" and a package.json that looks like\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"package.json\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"json\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"example-node-nix\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"1.0.0\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"main\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"dist/index.js\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"bin\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"example-node-nix\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"dist/index.js\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  },\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"scripts\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"build\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"tsc -p tsconfig.json\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"start\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"node dist/index.js\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  },\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"license\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"MIT\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"dependencies\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"fastify\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"^4.5.3\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  },\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"devDependencies\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"@tsconfig/node16\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"^1.0.1\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"@tsconfig/node16-strictest\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"^1.0.0\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"@types/node\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"^18.7.14\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\",\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"typescript\"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FE\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\":\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"^4.8.2\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  }\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I made a simple \",(0,l.jsx)(e.code,{children:\"flake.nix\"}),\" to set up node then ran\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"sh\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"$ npm run build\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"$ npm run start\"})})]})})]}),`\n`,(0,l.jsx)(e.p,{children:\"The sever is up and is responding.\"}),`\n`,(0,l.jsxs)(e.h2,{id:\"nix-builds\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#nix-builds\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"Nix Builds\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Like usual with nix I first try to see if other people have figured this out already, looking at the \",(0,l.jsx)(e.a,{href:\"https://nixos.org/manual/nixpkgs/stable/#language-javascript\",children:\"nixpkgs JS docs\"}),\", it mentions a few builders like \",(0,l.jsx)(e.code,{children:\"mkYarnPackage\"}),\", \",(0,l.jsx)(e.a,{href:\"https://github.com/svanderburg/node2nix\",children:\"node2nix\"}),\", \",(0,l.jsx)(e.a,{href:\"https://github.com/nix-community/npmlock2nix\",children:\"npmlock2nix\"}),\", and \",(0,l.jsx)(e.a,{href:\"https://github.com/serokell/nix-npm-buildpackage\",children:\"nix-npm-buildpackage\"}),\". These all seemed fine but I couldnt find any good typescript example, or the docs were a little lacking to get started. So I figured why not just do it the dumb way to start and do it manually, what's the worst that can happen?\"]}),`\n`,(0,l.jsxs)(e.h3,{id:\"the-standard-environment\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#the-standard-environment\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Standard Environment\"]}),`\n`,(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.a,{href:\"https://nixos.org/manual/nixpkgs/stable/#sec-using-stdenv\",children:\"stdenv.mkDerivation\"}),' is what most \"high level\" builders wrap. It provides you a sandbox environment with some common programs like ',(0,l.jsx)(e.code,{children:\"coreutils\"}),\", \",(0,l.jsx)(e.code,{children:\"grep\"}),\", \",(0,l.jsx)(e.code,{children:\"awk\"}),\", \",(0,l.jsx)(e.code,{children:\"make\"}),\", etc., to build a program. It is very versatile and surprisingly easy to use once you get comfortable with its ideas. I was hopeful I could throw something together, so to start I just focused on the \",(0,l.jsx)(e.code,{children:\"buildPhase\"}),\" and a very basic \",(0,l.jsx)(e.code,{children:\"installPhase\"}),\" to verify everything was built, I would deal with running it later.\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"flake.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"description\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"Sample Nix ts-node build\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:numtide/flake-utils\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:hercules-ci/gitignore.nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"follows\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"nixpkgs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"outputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"self\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"... \"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"eachDefaultSystem\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\":\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; };\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs-16_x\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# NOTE: this does not work\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"appBuild\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"example-ts-node\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"0.1.0\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignoreSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# uses the gitignore in the repo to only copy files git would see\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildInputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# https://nixos.org/manual/nixpkgs/stable/#sec-stdenv-phases\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # each phase has pre/postHooks. When you make your own phase be sure to still call the hooks\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook preBuild\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            npm ci\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            npm run build\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook postBuild\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"          ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"installPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook preInstall\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp -r node_modules $out/node_modules\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp package.json $out/package.json\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp -r dist $out/dist\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook postInstall\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"          ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"with\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"defaultPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"appBuild\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"devShell\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkShell\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildInputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]; };\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      });\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I tried \",(0,l.jsx)(e.code,{children:\"nix build\"}),\" but I got this error\"]}),`\n`,(0,l.jsx)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsx)(e.code,{children:(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"undefined\"},children:`error: builder for '/nix/store/7lis43p7zj10y2cf6inzicjdgzc3b5qs-example-ts-node.drv' failed with exit code 1;\n       last 10 log lines:\n       \u003e no configure script, doing nothing\n       \u003e building\n       \u003e npm ERR! code EAI_AGAINler: sill audit bulk request {[0m\n       \u003e npm ERR! syscall getaddrinfo\n       \u003e npm ERR! errno EAI_AGAIN\n       \u003e npm ERR! request to https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz failed, reason: getaddrinfo EAI_AGAIN registry.npmjs.org\n       \u003e\n       \u003e npm ERR! Log files were not written due to an error writing to the directory: /homeless-shelter/.npm/_logs\n       \u003e npm ERR! You can rerun the command with \\`--loglevel=verbose\\` to see the logs in your terminal\n       \u003e\n       For full logs, run 'nix log /nix/store/7lis43p7zj10y2cf6inzicjdgzc3b5qs-example-ts-node.drv'.`})})})})}),`\n`,(0,l.jsxs)(e.p,{children:[\"The error \",(0,l.jsx)(e.code,{children:\"getaddrinfo EAI_AGAIN registry.npmjs.org\"}),\" is a failure to connect to the NPM registry to install the dependencies. What I failed to realize is that the nix sandbox would block outside requests in the builder since they are not fully reproducible. You can disable the nix sandbox, but that would be gross. So time to try one of these builders.\"]}),`\n`,(0,l.jsxs)(e.h3,{id:\"node2nix\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#node2nix\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"node2nix\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Of all the builders I've seen so far \",(0,l.jsx)(e.a,{href:\"https://github.com/svanderburg/node2nix\",children:\"node2nix\"}),\" seemed like the most mature. It's actually used in the \",(0,l.jsx)(e.a,{href:\"https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/node-packages\",children:\"official nixpkgs repo\"}),\". At a high level \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" will parse your \",(0,l.jsx)(e.code,{children:\"package.json\"}),\" or \",(0,l.jsx)(e.code,{children:\"package-lock.json\"}),\" and do code-gen to give you nix files that use \",(0,l.jsx)(e.a,{href:\"https://ryantm.github.io/nixpkgs/builders/fetchers/\",children:\"fetchers\"}),\" to download all \",(0,l.jsx)(e.code,{children:\"node_modules\"}),\" and build your node app.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"You can install \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" from \",(0,l.jsx)(e.code,{children:\"nixpkgs\"}),\" as \",(0,l.jsx)(e.code,{children:\"pkgs.node2nix\"}),\". To run it I have this script\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"runNode2Nix.sh\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"sh\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"#!/usr/bin/env bash\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# You need to re-run this file anytime your package/package-lock.json changes\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"node2nix -16 --development \\\\\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    --input package.json \\\\\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    --lock package-lock.json \\\\\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# Put all generated code in the `./nix` directory\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    --node-env ./nix/node-env.nix \\\\\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    --composition ./nix/default.nix \\\\\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    --output ./nix/node-package.nix\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"While node2nix does have helpers in \",(0,l.jsx)(e.code,{children:\"node-env.nix\"}),\" to build a node package, those only really run \",(0,l.jsx)(e.code,{children:\"npm install\"}),\", to call our \",(0,l.jsx)(e.code,{children:\"npm run build\"}),\" step. Thankfully as described \",(0,l.jsx)(e.a,{href:\"https://github.com/svanderburg/node2nix#using-the-nodejs-environment-in-other-nix-derivations\",children:\"here\"}),\" \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" exposes an output of just the \",(0,l.jsx)(e.code,{children:\"node_modules\"}),\" of the dependencies, allowing us to make our own derivation.\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"flake.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"description\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"Sample Nix ts-node build\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:numtide/flake-utils\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:hercules-ci/gitignore.nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"follows\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"nixpkgs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"outputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"self\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"... \"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"eachDefaultSystem\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\":\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; };\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs-16_x\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"node2nixOutput\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; };\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# NOTE: may want to try https://github.com/svanderburg/node2nix/issues/301 to limit rebuilds\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nodeDeps\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"node2nixOutput\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodeDependencies\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"stdenv\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkDerivation\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"example-ts-node\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"version\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"0.1.0\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"src\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignoreSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildInputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook preBuild\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # symlink the generated node deps to the current directory for building\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            ln -sf \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodeDeps\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/lib/node_modules ./node_modules\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'            export PATH=\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodeDeps\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'/bin:$PATH\"'})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            npm run build\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook postBuild\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"          ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"installPhase\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"''\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook preInstall\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # Note: you need some sort of `mkdir` on $out for any of the following commands to work\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            mkdir -p $out/bin\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # copy only whats needed for running the built app\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp package.json $out/package.json\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp -r dist $out/dist\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            ln -sf \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodeDeps\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"/lib/node_modules $out/node_modules\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # copy entry point, in this case our index.ts has the node shebang\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # nix will patch the shebang to be the node version specified in buildInputs\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            # you could also copy in a script that is basically `npm run start`\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            cp dist/index.js $out/bin/example-ts-nix\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            chmod a+x $out/bin/example-ts-nix\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"            runHook postInstall\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"          ''\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"with\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"defaultPackage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"devShell\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"mkShell\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"buildInputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nodejs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"node2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]; };\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      });\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})}),(0,l.jsx)(e.div,{className:\"line\"})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"After running \",(0,l.jsx)(e.code,{children:\"nix build\"}),\", the output will be symlinked to \",(0,l.jsx)(e.code,{children:\"./result\"}),\" in my case it looks like\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"sh\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"$ exa --tree --level 3 ./result/\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"./result\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 bin\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2502  \\u2514\\u2500\\u2500 example-ts-nix\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 dist\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2502  \\u2514\\u2500\\u2500 index.js\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 node_modules -\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003e\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" /nix/store/fdzk00z6bmw50mfqv124lgn9fzjhd7yw-node-dependencies-example-node-nix-1.0.0/lib/node_modules\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 package.json\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"To verify the app worked you can run \",(0,l.jsx)(e.code,{children:\"./result/bin/example-ts-nix\"}),\".\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"While at first this looks like a lot It's pretty straightforward. \",(0,l.jsx)(e.code,{children:\"node2nixOutput = import ./nix { inherit pkgs nodejs system; };\"}),\" calls the generated \",(0,l.jsx)(e.code,{children:\"default.nix\"}),\" which exposes many outputs for building. In our case we only use \",(0,l.jsx)(e.code,{children:\"nodeDeps = node2nixOutput.nodeDependencies;\"}),\".\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The \",(0,l.jsx)(e.code,{children:\"buildPhase\"}),\" just symlinks the generated \",(0,l.jsx)(e.code,{children:\"nodeDependencies\"}),\" and builds the app. The \",(0,l.jsx)(e.code,{children:\"installPhase\"}),` copies the built output into the final derivation. If your familiar with docker files this is sorta like having a build layer than a final layer to copy the outputs to.\nOne thing nix does for you is patch shebangs to reference the `,(0,l.jsx)(e.code,{children:\"buildInputs\"}),\" of the derivation, in this case if you run\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"sh\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"$ cat ./result/bin/example-ts-nix\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"#!/nix/store/6cdccplrjwga5rd3b2s7xb8zd25hnsix-nodejs-16.17.0/bin/node\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"use strict\"}),(0,l.jsx)(e.span,{style:{color:\"#E9F284\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"...\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"It changed \",(0,l.jsx)(e.code,{children:\"#!/usr/bin/env node\"}),\" to \",(0,l.jsx)(e.code,{children:\"#!/nix/store/6cdccplrjwga5rd3b2s7xb8zd25hnsix-nodejs-16.17.0/bin/node\"}),\" for us automatically.\"]}),`\n`,(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:\"node2nix Pros\"})}),`\n`,(0,l.jsxs)(e.ul,{children:[`\n`,(0,l.jsx)(e.li,{children:\"Simple to follow build process\"}),`\n`,(0,l.jsx)(e.li,{children:\"Somewhat easy to customize\"}),`\n`,(0,l.jsx)(e.li,{children:\"Has support for custom registries/private git repos\"}),`\n`]}),`\n`,(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:\"node2nix Cons\"})}),`\n`,(0,l.jsxs)(e.ul,{children:[`\n`,(0,l.jsxs)(e.li,{children:[\"Having to re-run \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" on package.json changes is annoying\"]}),`\n`,(0,l.jsxs)(e.li,{children:[\"The generated outputs seem to re-build too often, see \",(0,l.jsx)(e.a,{href:\"https://github.com/svanderburg/node2nix/issues/301\",children:\"here\"})]}),`\n`,(0,l.jsxs)(e.li,{children:[\"With the current setup the final build is still using the development \",(0,l.jsx)(e.code,{children:\"node_modules\"}),\" which is wasteful\"]}),`\n`]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Overall I think \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" is a good start for most node apps. Since its all mostly code-gen It's easy to follow what's going on. I've come across \",(0,l.jsx)(e.a,{href:\"https://github.com/MatrixAI/TypeScript-Demo-Lib-Native\",children:\"this template\"}),\" which seems to have figured out to work around some cons listed, but I have not tried it yet so your mileage may vary.\"]}),`\n`,(0,l.jsxs)(e.h3,{id:\"dream2nix\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#dream2nix\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"dream2nix\"]}),`\n`,(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.a,{href:\"https://github.com/nix-community/dream2nix\",children:\"dream2nix\"}),' says its \"A framework for automated nix packaging\" by mostly standardizing the many \"2nix\" tools. The ',(0,l.jsx)(e.a,{href:\"https://nix-community.github.io/dream2nix/\",children:\"docs\"}),` list Rust, Haskell, Python, and Node builders.\nFor whatever reason I have been skeptical of dream2nix. It looked \"too good to be true\" so I never really gave it a fair shake. Better late than never, let's try it`]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"flake.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"description\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"Sample Nix ts-node build\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:numtide/flake-utils\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:hercules-ci/gitignore.nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"follows\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"nixpkgs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nix-community/dream2nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"outputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"self\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"... \"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# Note: no need for flake-utils.lib.eachDefaultSystem, dream2nix does it for us\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"makeFlakeOutputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"systems\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"defaultSystems\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"config\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"projectRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"source\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignoreSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"The core idea of dream2nix is that it will find you package.json/package-lock.json to figure out what node deps you need and how to build \",(0,l.jsx)(e.code,{children:\"npm run build\"}),' or w/e else. You can customize it but for most apps this should \"just work\".']}),`\n`,(0,l.jsxs)(e.p,{children:[\"Running \",(0,l.jsx)(e.code,{children:\"nix flake show\"}),\" returns\"]}),`\n`,(0,l.jsx)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsx)(e.code,{children:(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"undefined\"},children:`git+file:///home/jr/code/node/example-node-nix\n\\u251C\\u2500\\u2500\\u2500devShell\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-darwin: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-linux: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500i686-linux: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500x86_64-darwin: development environment 'nix-shell'\n\\u2502   \\u2514\\u2500\\u2500\\u2500x86_64-linux: development environment 'nix-shell'\n\\u251C\\u2500\\u2500\\u2500devShells\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-darwin\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: development environment 'nix-shell'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500example-node-nix: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-linux\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: development environment 'nix-shell'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500example-node-nix: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500i686-linux\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: development environment 'nix-shell'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500example-node-nix: development environment 'nix-shell'\n\\u2502   \\u251C\\u2500\\u2500\\u2500x86_64-darwin\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: development environment 'nix-shell'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500example-node-nix: development environment 'nix-shell'\n\\u2502   \\u2514\\u2500\\u2500\\u2500x86_64-linux\n\\u2502       \\u251C\\u2500\\u2500\\u2500default: development environment 'nix-shell'\n\\u2502       \\u2514\\u2500\\u2500\\u2500example-node-nix: development environment 'nix-shell'\n\\u251C\\u2500\\u2500\\u2500packages\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-darwin\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500example-node-nix: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500resolveImpure: package 'resolve'\n\\u2502   \\u251C\\u2500\\u2500\\u2500aarch64-linux\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500example-node-nix: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500resolveImpure: package 'resolve'\n\\u2502   \\u251C\\u2500\\u2500\\u2500i686-linux\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500example-node-nix: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500resolveImpure: package 'resolve'\n\\u2502   \\u251C\\u2500\\u2500\\u2500x86_64-darwin\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500default: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u251C\\u2500\\u2500\\u2500example-node-nix: package 'example-node-nix-1.0.0'\n\\u2502   \\u2502   \\u2514\\u2500\\u2500\\u2500resolveImpure: package 'resolve'\n\\u2502   \\u2514\\u2500\\u2500\\u2500x86_64-linux\n\\u2502       \\u251C\\u2500\\u2500\\u2500default: package 'example-node-nix-1.0.0'\n\\u2502       \\u251C\\u2500\\u2500\\u2500example-node-nix: package 'example-node-nix-1.0.0'\n\\u2502       \\u2514\\u2500\\u2500\\u2500resolveImpure: package 'resolve'\n\\u2514\\u2500\\u2500\\u2500projectsJson: unknown`})})})})}),`\n`,(0,l.jsxs)(e.p,{children:[\"dream2nix gave us a dev shell and package build for us, neat. Expecting something to break I ran \",(0,l.jsx)(e.code,{children:\"nix build\"}),\" to build the app and got no errors. Looking at \",(0,l.jsx)(e.code,{children:\"./result\"}),\" gives\"]}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"sh\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"$ exa --tree --level 3 ./result/\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"./result\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u251C\\u2500\\u2500 bin\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2502  \\u2514\\u2500\\u2500 ts-node-nix -\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"\u003e\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ../lib/node_modules/example-node-nix/dist/index.js\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"\\u2514\\u2500\\u2500 lib\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"   \\u2514\\u2500\\u2500 node_modules\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \\u2514\\u2500\\u2500 example-node-nix\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.code,{children:\"ts-node-nix\"}),\" is a compiled javascript file with the right shebang. Still somewhat shocked running \",(0,l.jsx)(e.code,{children:\"./result/bin/ts-node-nix\"}),\" ran the server, and it worked!\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"This is simply wild, I really expected something to break here and require a manual build step of some kind. One nice thing to note is the \",(0,l.jsx)(e.a,{href:\"https://nix-community.github.io/dream2nix/guides/getting-started-nodejs.html#development-shell\",children:\"node dev shell\"}),\" it gives will copy over the \",(0,l.jsx)(e.code,{children:\"node_modules\"}),\" folder for you so you don't need to manually run \",(0,l.jsx)(e.code,{children:\"npm install\"}),\".\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"To limit my excitement a bit this is a simple build. I need to investigate how well it works with more complicated builds with native node add-ons, mono repo tools like NX, etc. Though the examples in the \",(0,l.jsx)(e.a,{href:\"https://github.com/nix-community/dream2nix#test-the-experimental-version-of-dream2nix\",children:\"README\"}),\" seem promising to allow for easily overriding the builds.\"]}),`\n`,(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:\"dream2nix Pros\"})}),`\n`,(0,l.jsxs)(e.ul,{children:[`\n`,(0,l.jsx)(e.li,{children:\"very little code to set up\"}),`\n`,(0,l.jsx)(e.li,{children:\"generated dev shell is really nice\"}),`\n`]}),`\n`,(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:\"dream2nix Cons\"})}),`\n`,(0,l.jsxs)(e.ul,{children:[`\n`,(0,l.jsx)(e.li,{children:'A bit of a \"black box\" which could make debugging harder'}),`\n`,(0,l.jsx)(e.li,{children:\"It seems to include the full development dependencies in the output\"}),`\n`]}),`\n`,(0,l.jsxs)(e.h2,{id:\"conclusion\",children:[(0,l.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,l.jsx)(e.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I came into this thinking building ts node apps with nix would be a pain, and I'm happily surprised it is not. While \",(0,l.jsx)(e.code,{children:\"node2nix\"}),\" may be good for highly customizable builds, \",(0,l.jsx)(e.code,{children:\"dream2nix\"}),\" is just a delight. I haven't come across a nix utility that just worked like that with minimal messing around.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"I've been meaning to give \",(0,l.jsx)(e.a,{href:\"https://napi.rs/\",children:\"napi-rs\"}),\" a shot, so maybe that will be a good test case to see how well \",(0,l.jsx)(e.code,{children:\"dream2nix\"}),\" builds rust projects and native node add-ons all in one.\"]}),`\n`,(0,l.jsxs)(e.p,{children:[\"Since you made it to the end here's a \",(0,l.jsx)(e.code,{children:\"dream2nix\"}),\" example with a docker build\"]}),`\n`,(0,l.jsx)(\"div\",{className:\"remark-code-title\",children:\"flake.nix\"}),`\n`,(0,l.jsxs)(e.pre,{className:\"shiki dracula\",style:{backgroundColor:\"#282A36\",color:\"#F8F8F2\"},children:[(0,l.jsx)(e.div,{className:\"language-id\",children:\"nix\"}),(0,l.jsx)(e.div,{className:\"code-container\",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"{\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"description\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"Sample Nix ts-node build\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nixos/nixpkgs/nixos-unstable\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:numtide/flake-utils\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:hercules-ci/gitignore.nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"inputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"follows\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"nixpkgs\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"url\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"github:nix-community/dream2nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"  \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"outputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"self\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\",\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"... \"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}:\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"dream2nixOutputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nix\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"makeFlakeOutputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"systems\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"defaultSystems\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"config\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"projectRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"source\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignore\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"gitignoreSource\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:\"./.\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      };\"})}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"customOutput\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"flake-utils\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"eachDefaultSystem\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" (\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\":\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"let\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#8BE9FD\"},children:\"import\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"inherit\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; };\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# the dream2nix output for this system\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nixOutputs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"packages\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"${\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"system\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"}\"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"'}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"example-node-nix\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"with\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"; {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"packages\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"docker\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dockerTools\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildImage\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"packageName\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"copyToRoot\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"pkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"buildEnv\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" {\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"              \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"name\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"packageName\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"              \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"paths\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"app\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"              \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"pathsToLink\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/bin\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/lib\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ];\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            };\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# This ensures symlinks to directories are preserved in the image\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"keepContentsDirlinks\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#BD93F9\"},children:\"true\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"            \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"config\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" { \"}),(0,l.jsx)(e.span,{style:{color:\"#50FA7B\"},children:\"Cmd\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"=\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" [ \"}),(0,l.jsx)(e.span,{style:{color:\"#F1FA8C\"},children:'\"/bin/ts-node-nix\"'}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" ]; };\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"          };\"})}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"        });\"})}),(0,l.jsx)(e.div,{className:\"line\"}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"      \"}),(0,l.jsx)(e.span,{style:{color:\"#6272A4\"},children:\"# deep merge outputs together\"})]}),(0,l.jsxs)(e.div,{className:\"line\",children:[(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"    \"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\"in\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"nixpkgs\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"lib\"}),(0,l.jsx)(e.span,{style:{color:\"#FF79C6\"},children:\".\"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"recursiveUpdate\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"dream2nixOutputs\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\" \"}),(0,l.jsx)(e.span,{style:{color:\"#FFB86C\"},children:\"customOutput\"}),(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\";\"})]}),(0,l.jsx)(e.div,{className:\"line\",children:(0,l.jsx)(e.span,{style:{color:\"#F8F8F2\"},children:\"}\"})})]})})]}),`\n`,(0,l.jsxs)(e.p,{children:[\"You can then run \",(0,l.jsx)(e.code,{children:\"nix build .#docker\"}),\" and then run \",(0,l.jsx)(e.code,{children:\"docker load \u003c result\"}),\" to load the image into docker. See \",(0,l.jsx)(e.a,{href:\"/blog/rust-enviorment-and-docker-build-with-nix-flakes\",children:\"here\"}),\" for some more info on nix docker builds.\"]})]})}}var N=x;function B(n,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+n+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return k;})();\n;return Component;","toc":[{"value":"Being a Nix Stan","url":"#being-a-nix-stan","depth":2},{"value":"The APP","url":"#the-app","depth":2},{"value":"Nix Builds","url":"#nix-builds","depth":2},{"value":"The Standard Environment","url":"#the-standard-environment","depth":3},{"value":"node2nix","url":"#node2nix","depth":3},{"value":"dream2nix","url":"#dream2nix","depth":3},{"value":"Conclusion","url":"#conclusion","depth":2}],"frontMatter":{"readingTime":{"text":"13 min read","minutes":12.505,"time":750300,"words":2501},"slug":"building-typescript-node-apps-with-nix","fileName":"building-typescript-node-apps-with-nix.md","title":"Building Typescript Node Apps With Nix","date":"2022-09-06T23:57:55.477Z","tags":["nix","typescript","node"],"draft":false,"summary":"Trying some different nix builders for typescript node apps","images":[],"layout":"PostLayout"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.215,"time":12900,"words":43},"slug":["default"],"fileName":"default.md","name":"John Murray","avatar":"/static/images/me.jpg","occupation":"Software Engineer","github":"https://github.com/JRMurr","twitter":"https://twitter.com/JRMurrCodes","date":null}],"prev":{"title":"Making a PR to Nixpkgs","date":"2022-08-02T03:43:05.229Z","tags":["nix","rust"],"draft":false,"summary":"My rough ramblings on how to contribute a small pr to Nixpkgs","images":[],"layout":"PostLayout","slug":"updating-a-package-in-nixpkgs"},"next":null},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["building-typescript-node-apps-with-nix"]},"buildId":"_5dYUg91qj2NP5UkDuoCq","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>